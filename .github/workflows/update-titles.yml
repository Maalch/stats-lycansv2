name: Update Player Titles

on:
  schedule:
    # Run every Sunday at 6 AM UTC (independent from data sync)
    - cron: '0 6 * * 0'
  workflow_dispatch: # Allow manual triggering
    inputs:
      team:
        description: 'Team to generate titles for'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - main
          - discord

jobs:
  update-titles:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Install dependencies
        run: |
          cd scripts/data-sync
          npm install

      - name: Generate player titles (Main Team)
        if: ${{ inputs.team == 'all' || inputs.team == 'main' || inputs.team == '' }}
        run: |
          echo "ðŸ·ï¸  Generating player titles for Main Team..."
          node scripts/data-sync/generate-titles.js main
          echo "âœ… Main Team titles generated"

      - name: Generate player titles (Discord Team)
        if: ${{ inputs.team == 'all' || inputs.team == 'discord' || inputs.team == '' }}
        run: |
          echo "ðŸ·ï¸  Generating player titles for Discord Team..."
          # Check if discord data exists
          if [ -f "data/discord/gameLog.json" ]; then
            node scripts/data-sync/generate-titles.js discord
            echo "âœ… Discord Team titles generated"
          else
            echo "âš ï¸  Discord Team data not found, skipping..."
          fi

      - name: Validate title files
        run: |
          echo "ðŸ” Validating generated title files..."
          
          # Validate Main Team titles
          if [ -f "data/playerTitles.json" ]; then
            if jq empty "data/playerTitles.json" 2>/dev/null; then
              PLAYER_COUNT=$(jq '.totalPlayers' data/playerTitles.json)
              echo "âœ… Main Team: playerTitles.json valid ($PLAYER_COUNT players)"
            else
              echo "âŒ Main Team: Invalid JSON in playerTitles.json"
              exit 1
            fi
          else
            echo "âŒ Main Team: playerTitles.json not found!"
            exit 1
          fi
          
          # Validate Discord Team titles (optional)
          if [ -f "data/discord/playerTitles.json" ]; then
            if jq empty "data/discord/playerTitles.json" 2>/dev/null; then
              PLAYER_COUNT=$(jq '.totalPlayers' data/discord/playerTitles.json)
              echo "âœ… Discord Team: playerTitles.json valid ($PLAYER_COUNT players)"
            else
              echo "âŒ Discord Team: Invalid JSON in playerTitles.json"
              exit 1
            fi
          else
            echo "â„¹ï¸  Discord Team: No titles file (data may not exist)"
          fi
          
          echo "âœ… All title files validated successfully"

      - name: Copy titles to docs folder
        run: |
          # Copy Main Team titles
          cp data/playerTitles.json docs/data/playerTitles.json
          echo "âœ… Copied Main Team titles to docs/data/"
          
          # Copy Discord Team titles if exists
          if [ -f "data/discord/playerTitles.json" ]; then
            mkdir -p docs/data/discord
            cp data/discord/playerTitles.json docs/data/discord/playerTitles.json
            echo "âœ… Copied Discord Team titles to docs/data/discord/"
          fi

      - name: Commit and push if changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add data/playerTitles.json docs/data/playerTitles.json
          git add data/discord/playerTitles.json docs/data/discord/playerTitles.json 2>/dev/null || true
          if ! git diff --cached --quiet; then
            git commit -m "chore: update player titles $(date '+%Y-%m-%d %H:%M:%S')"
            git push
            echo "âœ… Titles updated and pushed successfully"
          else
            echo "â„¹ï¸  No title changes detected - skipping commit"
          fi

      - name: Summary
        if: always()
        run: |
          echo "ðŸ” Player Titles Workflow Summary:"
          echo "- Title generation completed"
          echo "- Team(s) processed: ${{ inputs.team || 'all' }}"
          echo "- Timestamp: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          
          # Show Main Team summary
          if [ -f "data/playerTitles.json" ]; then
            echo "ðŸ“Š Main Team Stats:"
            TOTAL_PLAYERS=$(jq '.totalPlayers' data/playerTitles.json)
            MODDED_GAMES=$(jq '.moddedGamesAnalyzed' data/playerTitles.json)
            MIN_GAMES=$(jq '.minGamesRequired' data/playerTitles.json)
            echo "   - Players with titles: $TOTAL_PLAYERS"
            echo "   - Modded games analyzed: $MODDED_GAMES"
            echo "   - Minimum games required: $MIN_GAMES"
          fi
          
          # Show Discord Team summary
          if [ -f "data/discord/playerTitles.json" ]; then
            echo ""
            echo "ðŸ“Š Discord Team Stats:"
            TOTAL_PLAYERS=$(jq '.totalPlayers' data/discord/playerTitles.json)
            MODDED_GAMES=$(jq '.moddedGamesAnalyzed' data/discord/playerTitles.json)
            echo "   - Players with titles: $TOTAL_PLAYERS"
            echo "   - Modded games analyzed: $MODDED_GAMES"
          fi
          
          echo ""
          ls -la data/playerTitles.json 2>/dev/null || echo "No Main Team titles file"
          ls -la data/discord/playerTitles.json 2>/dev/null || echo "No Discord Team titles file"
