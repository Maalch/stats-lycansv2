name: Update Achievements & Titles

on:
  schedule:
    # Run every Sunday at 6 AM UTC (once a week)
    - cron: '0 6 * * 0'
  workflow_dispatch: # Allow manual triggering
    inputs:
      team:
        description: 'Team to generate achievements and titles for'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - main
          - discord
      force_recalculation:
        description: 'Force full recalculation (ignore cache)'
        required: false
        default: false
        type: boolean

jobs:
  update-achievements-titles:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Install dependencies
        run: |
          cd scripts/data-sync
          npm install

      # ========================================
      # MAIN TEAM - Achievements & Titles
      # ========================================
      - name: Generate achievements (Main Team)
        if: ${{ inputs.team == 'all' || inputs.team == 'main' || inputs.team == '' }}
        run: |
          echo "ðŸ† Generating achievements for Main Team..."
          if [ "${{ inputs.force_recalculation }}" == "true" ]; then
            echo "ðŸ”„ Mode: FULL RECALCULATION (forced)"
            node scripts/data-sync/generate-achievements.js main --force-full
          else
            echo "ðŸ”„ Mode: INCREMENTAL"
            node scripts/data-sync/generate-achievements.js main
          fi
          echo "âœ… Main Team achievements generated"

      - name: Generate titles (Main Team)
        if: ${{ inputs.team == 'all' || inputs.team == 'main' || inputs.team == '' }}
        run: |
          echo "ðŸ·ï¸  Generating titles for Main Team..."
          node scripts/data-sync/generate-titles.js main
          echo "âœ… Main Team titles generated"

      # ========================================
      # DISCORD TEAM - Achievements & Titles
      # ========================================
      - name: Generate achievements (Discord Team)
        if: ${{ inputs.team == 'all' || inputs.team == 'discord' || inputs.team == '' }}
        run: |
          echo "ðŸ† Generating achievements for Discord Team..."
          # Check if discord data exists
          if [ -f "data/discord/gameLog.json" ]; then
            if [ "${{ inputs.force_recalculation }}" == "true" ]; then
              echo "ðŸ”„ Mode: FULL RECALCULATION (forced)"
              node scripts/data-sync/generate-achievements.js discord --force-full
            else
              echo "ðŸ”„ Mode: INCREMENTAL"
              node scripts/data-sync/generate-achievements.js discord
            fi
            echo "âœ… Discord Team achievements generated"
          else
            echo "âš ï¸  Discord Team data not found, skipping..."
          fi

      - name: Generate titles (Discord Team)
        if: ${{ inputs.team == 'all' || inputs.team == 'discord' || inputs.team == '' }}
        run: |
          echo "ðŸ·ï¸  Generating titles for Discord Team..."
          # Check if discord data exists
          if [ -f "data/discord/gameLog.json" ]; then
            node scripts/data-sync/generate-titles.js discord
            echo "âœ… Discord Team titles generated"
          else
            echo "âš ï¸  Discord Team data not found, skipping..."
          fi

      # ========================================
      # VALIDATION
      # ========================================
      - name: Validate generated files
        run: |
          echo "ðŸ” Validating generated files..."
          
          # Validate Main Team achievements
          if [ -f "data/playerAchievements.json" ]; then
            if jq empty "data/playerAchievements.json" 2>/dev/null; then
              PLAYER_COUNT=$(jq '.totalPlayers' data/playerAchievements.json)
              echo "âœ… Main Team: playerAchievements.json valid ($PLAYER_COUNT players)"
            else
              echo "âŒ Main Team: Invalid JSON in playerAchievements.json"
              exit 1
            fi
          else
            echo "âš ï¸  Main Team: playerAchievements.json not found"
          fi
          
          # Validate Main Team titles
          if [ -f "data/playerTitles.json" ]; then
            if jq empty "data/playerTitles.json" 2>/dev/null; then
              PLAYER_COUNT=$(jq '.totalPlayers' data/playerTitles.json)
              echo "âœ… Main Team: playerTitles.json valid ($PLAYER_COUNT players)"
            else
              echo "âŒ Main Team: Invalid JSON in playerTitles.json"
              exit 1
            fi
          else
            echo "âš ï¸  Main Team: playerTitles.json not found"
          fi
          
          # Validate Main Team cache
          if [ -f "data/playerStatsCache.json" ]; then
            if jq -e '.version and .allGames and .moddedGames' data/playerStatsCache.json > /dev/null; then
              CACHE_VERSION=$(jq -r '.version' data/playerStatsCache.json)
              ALL_GAMES_CACHED=$(jq '.allGames.totalGames' data/playerStatsCache.json)
              MODDED_GAMES_CACHED=$(jq '.moddedGames.totalGames' data/playerStatsCache.json)
              echo "âœ… Main Team: Cache v$CACHE_VERSION ($ALL_GAMES_CACHED games, $MODDED_GAMES_CACHED modded)"
            else
              echo "âš ï¸  Main Team: Cache file has unexpected structure"
            fi
          fi
          
          # Validate Discord Team achievements (optional)
          if [ -f "data/discord/playerAchievements.json" ]; then
            if jq empty "data/discord/playerAchievements.json" 2>/dev/null; then
              PLAYER_COUNT=$(jq '.totalPlayers' data/discord/playerAchievements.json)
              echo "âœ… Discord Team: playerAchievements.json valid ($PLAYER_COUNT players)"
            else
              echo "âŒ Discord Team: Invalid JSON in playerAchievements.json"
              exit 1
            fi
          else
            echo "â„¹ï¸  Discord Team: No achievements file (data may not exist)"
          fi
          
          # Validate Discord Team titles (optional)
          if [ -f "data/discord/playerTitles.json" ]; then
            if jq empty "data/discord/playerTitles.json" 2>/dev/null; then
              PLAYER_COUNT=$(jq '.totalPlayers' data/discord/playerTitles.json)
              echo "âœ… Discord Team: playerTitles.json valid ($PLAYER_COUNT players)"
            else
              echo "âŒ Discord Team: Invalid JSON in playerTitles.json"
              exit 1
            fi
          else
            echo "â„¹ï¸  Discord Team: No titles file (data may not exist)"
          fi
          
          echo "âœ… All files validated successfully"

      # ========================================
      # COPY TO DOCS & COMMIT
      # ========================================
      - name: Copy files to docs folder
        run: |
          # Copy Main Team files
          cp data/playerAchievements.json docs/data/playerAchievements.json 2>/dev/null || true
          cp data/playerTitles.json docs/data/playerTitles.json 2>/dev/null || true
          cp data/playerStatsCache.json docs/data/playerStatsCache.json 2>/dev/null || true
          echo "âœ… Copied Main Team files to docs/data/"
          
          # Copy Discord Team files if exists
          if [ -d "data/discord" ]; then
            mkdir -p docs/data/discord
            cp data/discord/playerAchievements.json docs/data/discord/playerAchievements.json 2>/dev/null || true
            cp data/discord/playerTitles.json docs/data/discord/playerTitles.json 2>/dev/null || true
            cp data/discord/playerStatsCache.json docs/data/discord/playerStatsCache.json 2>/dev/null || true
            echo "âœ… Copied Discord Team files to docs/data/discord/"
          fi

      - name: Commit and push if changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Stage all achievement, title, and cache files
          git add data/playerAchievements.json docs/data/playerAchievements.json 2>/dev/null || true
          git add data/playerTitles.json docs/data/playerTitles.json 2>/dev/null || true
          git add data/playerStatsCache.json docs/data/playerStatsCache.json 2>/dev/null || true
          git add data/discord/playerAchievements.json docs/data/discord/playerAchievements.json 2>/dev/null || true
          git add data/discord/playerTitles.json docs/data/discord/playerTitles.json 2>/dev/null || true
          git add data/discord/playerStatsCache.json docs/data/discord/playerStatsCache.json 2>/dev/null || true
          
          if ! git diff --cached --quiet; then
            git commit -m "chore: update achievements and titles $(date '+%Y-%m-%d %H:%M:%S')"
            git push
            echo "âœ… Achievements and titles updated and pushed successfully"
          else
            echo "â„¹ï¸  No changes detected - skipping commit"
          fi

      - name: Summary
        if: always()
        run: |
          echo "ðŸ” Achievements & Titles Workflow Summary:"
          echo "- Team(s) processed: ${{ inputs.team || 'all' }}"
          echo "- Mode: ${{ inputs.force_recalculation == 'true' && 'FULL RECALCULATION' || 'INCREMENTAL' }}"
          echo "- Timestamp: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          
          # Show Main Team summary
          echo "ðŸ“Š Main Team:"
          if [ -f "data/playerAchievements.json" ]; then
            ACHIEVEMENTS_PLAYERS=$(jq '.totalPlayers' data/playerAchievements.json)
            echo "   - Achievements: $ACHIEVEMENTS_PLAYERS players"
          fi
          if [ -f "data/playerTitles.json" ]; then
            TITLES_PLAYERS=$(jq '.totalPlayers' data/playerTitles.json)
            MODDED_GAMES=$(jq '.moddedGamesAnalyzed' data/playerTitles.json)
            echo "   - Titles: $TITLES_PLAYERS players"
            echo "   - Modded games analyzed: $MODDED_GAMES"
          fi
          
          # Show Discord Team summary
          if [ -f "data/discord/playerAchievements.json" ]; then
            echo ""
            echo "ðŸ“Š Discord Team:"
            ACHIEVEMENTS_PLAYERS=$(jq '.totalPlayers' data/discord/playerAchievements.json)
            echo "   - Achievements: $ACHIEVEMENTS_PLAYERS players"
            if [ -f "data/discord/playerTitles.json" ]; then
              TITLES_PLAYERS=$(jq '.totalPlayers' data/discord/playerTitles.json)
              echo "   - Titles: $TITLES_PLAYERS players"
            fi
          fi
          
          echo ""
          echo "ðŸ“ Files updated:"
          ls -la data/playerAchievements.json data/playerTitles.json 2>/dev/null || echo "  No Main Team files"
          ls -la data/discord/playerAchievements.json data/discord/playerTitles.json 2>/dev/null || echo "  No Discord Team files"
