name: Update Discord Team Stats Data

on:
  schedule:
    # Run only on Monday, Thursday, and Saturday (the day after usual game days) at 4 AM UTC
    - cron: '0 4 * * 1,4,6'
  workflow_dispatch: # Allow manual triggering
    inputs:
      full_sync:
        description: 'Force full synchronization (re-fetch all games from AWS)'
        required: false
        default: false
        type: boolean
  push:
    paths:
      - '.github/workflows/update-discorddata.yml'

jobs:
  update-discord-data:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Install dependencies
        run: |
          cd scripts/data-sync
          npm install

      - name: Fetch and process Discord Team data
        env:
          # Discord Team AWS S3 URL
          STATS_LIST_URL: ${{ secrets.STATS_LIST_URL }}
        run: |
          echo "ðŸš€ Starting Discord Team data fetch from AWS S3..."
          echo "ðŸ“¡ AWS S3: ${STATS_LIST_URL:0:30}..." # Show partial URL for debugging
          
          # Determine sync mode
          if [ "${{ inputs.full_sync }}" == "true" ]; then
            echo "ðŸ”„ Sync mode: FULL (forced via workflow input)"
            node scripts/data-sync/fetch-data-unified.js discord --full
          else
            echo "ðŸ”„ Sync mode: INCREMENTAL (only new + recent games)"
            node scripts/data-sync/fetch-data-unified.js discord
          fi
          
          echo "âœ… Discord Team data fetch completed"
          echo "â„¹ï¸  Note: Achievements and titles are generated weekly via update-achievements-titles.yml"
          
      - name: Validate Discord Team data files
        run: |
          echo "ðŸ” Validating Discord Team data files..."
          
          # Check for required Discord Team data files in discord folder (achievements are generated separately)
          REQUIRED_FILES=(
            "data/discord/gameLog.json" 
            "data/discord/index.json" 
            "data/discord/joueurs.json"
          )
          
          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ Required file $file not found!"
              exit 1
            else
              echo "âœ… Found $file"
            fi
          done
          
          # Check if main data file is valid JSON
          if ! jq empty "data/discord/gameLog.json" 2>/dev/null; then
            echo "âŒ Invalid JSON in discord/gameLog.json"
            exit 1
          else
            echo "âœ… discord/gameLog.json is valid JSON"
          fi
          
          # Check file size (should not be empty)
          if [ ! -s "data/discord/gameLog.json" ]; then
            echo "âŒ discord/gameLog.json is empty"
            exit 1
          fi
          
          # Extract and display stats
          TOTAL_GAMES=$(jq '.TotalRecords' data/discord/gameLog.json)
          AWS_GAMES=$(jq '.Sources.AWS' data/discord/gameLog.json)
          echo "ðŸ“Š Discord Team Stats:"
          echo "   - Total games: $TOTAL_GAMES"
          echo "   - AWS games: $AWS_GAMES"
          
          echo "âœ… All Discord Team data files validated successfully"

      - name: Copy Discord Team data to docs folder
        run: |
          mkdir -p docs/data/discord
          cp -r data/discord/* docs/data/discord/
          echo "âœ… Discord Team data copied to docs/data/discord/"

      - name: Commit and push if changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add data/discord/ docs/data/discord/
          if ! git diff --cached --quiet; then
            git commit -m "chore: update Discord Team stats data from AWS S3 $(date '+%Y-%m-%d %H:%M:%S')"
            git push
            echo "âœ… Discord Team data updated and pushed successfully"
          else
            echo "â„¹ï¸  No Discord Team data changes detected - skipping commit"
          fi

      - name: Summary
        if: always()
        run: |
          echo "ðŸ” Discord Team Workflow Summary:"
          echo "- Data sync completed from AWS S3 (Discord Team)"
          echo "- Files updated: $(git diff --name-only HEAD~1 2>/dev/null | grep 'discord' | wc -l || echo '0')"
          echo "- Timestamp: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo "- Source: AWS S3 Discord Team bucket"
          echo "- Output folder: data/discord/"
          echo "- Data types: Game logs, Player data, Index"
          echo "- Note: Achievements and titles are generated weekly via update-achievements-titles.yml"
          ls -la data/discord/ 2>/dev/null || echo "No Discord Team data files found"
