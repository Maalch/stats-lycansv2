name: Update Lycans Stats Data

on:
  schedule:
    # Run every day at 4 AM UTC
    - cron: '0 4 * * *'
  workflow_dispatch: # Allow manual triggering
  push:
    paths:
      - 'scripts/data-sync/**'
      - '.github/workflows/update-data.yml'

jobs:
  update-data:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Install dependencies
        run: |
          cd scripts/data-sync
          npm install

      - name: Fetch and process data
        env:
          # Legacy Google Sheets API base (no trailing comma!)
          LYCANS_API_BASE: ${{ secrets.LYCANS_API_BASE }}
          STATS_LIST_URL: ${{ secrets.STATS_LIST_URL }}
        run: |
          cd scripts/data-sync
          echo "🚀 Starting multi-source data fetch..."
          echo "📡 Legacy API: ${LYCANS_API_BASE:0:10}..." # Show partial URL for debugging
          echo "📡 AWS S3: ${STATS_LIST_URL:0:10}..." # Show partial URL for debugging
          # Quick sanity check: legacy endpoint reachability (does not fail pipeline, just info)
          if [ -n "$LYCANS_API_BASE" ]; then
            LEGACY_PING_URL="${LYCANS_API_BASE}?action=gameLog"
            echo "🔍 Probing legacy endpoint (HEAD): $LEGACY_PING_URL"
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$LEGACY_PING_URL" || echo "000")
            echo "🔍 Legacy endpoint HTTP status: $HTTP_STATUS"
          else
            echo "⚠️  LYCANS_API_BASE not set (legacy data will be skipped)"
          fi
          node fetch-data.js
          echo "✅ Data fetch completed"
          
      - name: Validate data files
        run: |
          echo "🔍 Validating generated data files..."
          if [ ! -f "data/index.json" ]; then
            echo "❌ data/index.json not found!"
            exit 1
          fi
          
          # Check if data files are valid JSON
          for file in data/*.json; do
            if [ -f "$file" ]; then
              if ! jq empty "$file" 2>/dev/null; then
                echo "❌ Invalid JSON in $file"
                exit 1
              else
                echo "✅ $file is valid JSON"
              fi
            fi
          done
          
          # Check file sizes (should not be empty)
          for file in data/*.json; do
            if [ -f "$file" ] && [ ! -s "$file" ]; then
              echo "❌ $file is empty"
              exit 1
            fi
          done
          
          echo "✅ All data files validated successfully"

      - name: Copy data to docs folder
        run: |
          mkdir -p docs/data
          cp -r data/* docs/data/

      - name: Commit and push if changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add data/ docs/data/
          if ! git diff --cached --quiet; then
            git commit -m "chore: update stats data from Legacy + AWS sources $(date '+%Y-%m-%d %H:%M:%S')"
            git push
            echo "✅ Data updated and pushed successfully"
          else
            echo "ℹ️  No data changes detected - skipping commit"
          fi

      - name: Summary
        if: always()
        run: |
          echo "🔍 Workflow Summary:"
          echo "- Data sync completed from Legacy + AWS sources"
          echo "- Files updated: $(git diff --name-only HEAD~1 2>/dev/null | grep '^data/' | wc -l || echo '0')"
          echo "- Timestamp: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo "- Sources: Legacy Google Sheets API + AWS S3 Lycans Stats bucket"
          ls -la data/ || echo "No data directory found"
