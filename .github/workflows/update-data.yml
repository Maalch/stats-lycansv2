name: Update Lycans Stats Data

on:
  schedule:
    # Run only on Monday (before usual game day), Tuesday (game day), and Thursday (alternate game day) at 8 PM UTC (after game time)
    - cron: '0 20 * * 1,2,4'
  workflow_dispatch: # Allow manual triggering
    inputs:
      full_sync:
        description: 'Force full synchronization (re-fetch all games from AWS)'
        required: false
        default: false
        type: boolean
      force_achievements_recalc:
        description: 'Force full achievements/ranking recalculation (ignore cache)'
        required: false
        default: false
        type: boolean
  push:
    paths:
      - '.github/workflows/update-data.yml'

jobs:
  update-data:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Install dependencies
        run: |
          cd scripts/data-sync
          npm install

      - name: Fetch and process data
        env:
          # Legacy Google Sheets API base (no trailing comma!)
          LYCANS_API_BASE: ${{ secrets.LYCANS_API_BASE }}
          STATS_LIST_URL: ${{ secrets.STATS_LIST_URL }}
        run: |
          cd scripts/data-sync
          echo "ðŸš€ Starting multi-source data fetch..."
          echo "ðŸ“¡ Legacy API: ${LYCANS_API_BASE:0:10}..." # Show partial URL for debugging
          echo "ðŸ“¡ AWS S3: ${STATS_LIST_URL:0:10}..." # Show partial URL for debugging
          # Quick sanity check: legacy endpoint reachability (does not fail pipeline, just info)
          if [ -n "$LYCANS_API_BASE" ]; then
            LEGACY_PING_URL="${LYCANS_API_BASE}?action=gameLog"
            echo "ðŸ” Probing legacy endpoint (HEAD): $LEGACY_PING_URL"
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$LEGACY_PING_URL" || echo "000")
            echo "ðŸ” Legacy endpoint HTTP status: $HTTP_STATUS"
          else
            echo "âš ï¸  LYCANS_API_BASE not set (legacy data will be skipped)"
          fi
          
          # Build command with appropriate flags
          CMD="node fetch-data.js"
          
          # Determine sync mode
          if [ "${{ inputs.full_sync }}" == "true" ]; then
            echo "ðŸ”„ Sync mode: FULL (forced via workflow input)"
            CMD="$CMD --full"
          else
            echo "ðŸ”„ Sync mode: INCREMENTAL"
          fi
          
          # Determine achievements mode
          if [ "${{ inputs.force_achievements_recalc }}" == "true" ]; then
            echo "ðŸ”„ Achievements mode: FULL RECALCULATION (forced via workflow input)"
            CMD="$CMD --force-achievements"
          else
            echo "ðŸ”„ Achievements mode: INCREMENTAL"
          fi
          
          # Run the command
          $CMD
          echo "âœ… Data fetch completed"
          
      - name: Validate data files
        run: |
          echo "ðŸ” Validating generated data files..."
          if [ ! -f "data/index.json" ]; then
            echo "âŒ data/index.json not found!"
            exit 1
          fi
          
          # Check for required data files
          REQUIRED_FILES=("data/index.json" "data/gameLog.json" "data/rawBRData.json" "data/joueurs.json" "data/playerAchievements.json" "data/playerStatsCache.json")
          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ Required file $file not found!"
              exit 1
            fi
          done
          
          # Check if data files are valid JSON
          for file in data/*.json; do
            if [ -f "$file" ]; then
              if ! jq empty "$file" 2>/dev/null; then
                echo "âŒ Invalid JSON in $file"
                exit 1
              else
                echo "âœ… $file is valid JSON"
              fi
            fi
          done
          
          # Check file sizes (should not be empty)
          for file in data/*.json; do
            if [ -f "$file" ] && [ ! -s "$file" ]; then
              echo "âŒ $file is empty"
              exit 1
            fi
          done
          
          # Additional validation for joueurs.json structure
          if jq -e '.Players | type == "array"' data/joueurs.json > /dev/null; then
            PLAYER_COUNT=$(jq '.TotalRecords' data/joueurs.json)
            echo "âœ… joueurs.json contains $PLAYER_COUNT players"
          else
            echo "âŒ joueurs.json missing expected Players array"
            exit 1
          fi
          
          # Validate cache structure
          if [ -f "data/playerStatsCache.json" ]; then
            if jq -e '.version and .allGames and .moddedGames' data/playerStatsCache.json > /dev/null; then
              CACHE_VERSION=$(jq -r '.version' data/playerStatsCache.json)
              ALL_GAMES_CACHED=$(jq '.allGames.totalGames' data/playerStatsCache.json)
              MODDED_GAMES_CACHED=$(jq '.moddedGames.totalGames' data/playerStatsCache.json)
              echo "âœ… Cache file valid (v$CACHE_VERSION): $ALL_GAMES_CACHED games ($MODDED_GAMES_CACHED modded)"
            else
              echo "âš ï¸  Cache file exists but has unexpected structure"
            fi
          fi
          
          echo "âœ… All data files validated successfully"

      - name: Copy data to docs folder
        run: |
          mkdir -p docs/data
          cp -r data/* docs/data/

      - name: Commit and push if changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add data/ docs/data/
          if ! git diff --cached --quiet; then
            git commit -m "chore: update stats data from Legacy + AWS sources $(date '+%Y-%m-%d %H:%M:%S')"
            git push
            echo "âœ… Data updated and pushed successfully"
          else
            echo "â„¹ï¸  No data changes detected - skipping commit"
          fi

      - name: Summary
        if: always()
        run: |
          echo "ðŸ” Workflow Summary:"
          echo "- Data sync completed from Legacy + AWS sources"
          echo "- Sync mode: ${{ inputs.full_sync == 'true' && 'FULL' || 'INCREMENTAL' }}"
          echo "- Achievements: ${{ inputs.force_achievements_recalc == 'true' && 'FULL RECALC' || 'INCREMENTAL' }}"
          echo "- Files updated: $(git diff --name-only HEAD~1 2>/dev/null | grep '^data/' | wc -l || echo '0')"
          echo "- Timestamp: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo "- Sources: Legacy Google Sheets API + AWS S3 Lycans Stats bucket"
          echo "- Data types: Game logs, Battle Royale data, Player information, Achievements"
          echo "- Incremental processing: Enabled for both game sync and achievements generation"
          ls -la data/ || echo "No data directory found"
