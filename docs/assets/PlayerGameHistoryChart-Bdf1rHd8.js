import{r as v,u as V,j as r}from"./index-CkJED6Ft.js";import{u as B,a as K}from"./useRawGameData-CPCt2zKl.js";import{u as W}from"./usePlayerStatsFromRaw-DxhJVq55.js";import{l as H,a as I}from"./api-beq3FXpM.js";import{F as z,R as w,C as G,X as L,Y as M,T as D,B as q,o as R,p as P}from"./FullscreenChart-DGKulT7a.js";import{L as _,a as J}from"./LineChart-BwhDo9bC.js";import{P as O,a as X}from"./PieChart-D4On0gdB.js";function Y(c){const{data:x,isLoading:b,error:m}=B(),{data:o,isLoading:T,error:A}=K();return{data:v.useMemo(()=>{if(c.trim()===""||!x||x.length===0||!o||o.length===0)return null;const n=e=>e?e.split(",").map(t=>t.trim()).filter(Boolean):[],N=(e,t)=>t&&t.trim()!==""?n(t).some(s=>s.toLowerCase()===e.toLowerCase()):!1,S=(e,t,a)=>e[t]&&e[t][a]||"Villageois",$=e=>{if(e instanceof Date){const t=e.getDate().toString().padStart(2,"0"),a=(e.getMonth()+1).toString().padStart(2,"0"),s=e.getFullYear();return`${t}/${a}/${s}`}if(typeof e=="string"){if(/^\d{2}\/\d{2}\/\d{4}$/.test(e))return e;if(/^\d{4}-\d{2}-\d{2}$/.test(e)){const t=e.split("-");return`${t[2]}/${t[1]}/${t[0]}`}}return e?.toString()||""},g={};o.forEach(e=>{const t=e.Game?.toString();if(!t)return;g[t]||(g[t]={});const a=(s,i)=>{s&&n(s.toString()).forEach(u=>{const j=u.trim();j&&(g[t][j]=i)})};a(e.Loups,"Loups"),a(e.Traître,"Traître"),a(e["Idiot du village"],"Idiot du Village"),a(e.Cannibale,"Cannibale"),a(e.Agent,"Agent"),a(e.Espion,"Espion"),a(e.Scientifique,"Scientifique"),a(e.Amoureux,"Amoureux"),a(e["La Bête"],"La Bête"),a(e["Chasseur de primes"],"Chasseur de primes"),a(e.Vaudou,"Vaudou")});const d=[];x.forEach(e=>{const t=e.Game?.toString(),a=e.Date,s=e["Liste des joueurs"],i=e["Camp victorieux"],p=e["Liste des gagnants"];if(t&&s&&a&&p){const u=n(s.toString());if(u.some(y=>y.toLowerCase()===c.toLowerCase())){const y=S(g,t,c),E=N(c,p?.toString()),F=$(a);d.push({gameId:t,date:F,camp:y,won:E,winnerCamp:i?.toString()||"",playersInGame:u.length})}}}),d.sort((e,t)=>{const a=s=>{const i=s.split("/");return i.length===3?new Date(parseInt(i[2]),parseInt(i[1])-1,parseInt(i[0])):new Date(s)};return a(t.date).getTime()-a(e.date).getTime()});const h=d.length,f=d.filter(e=>e.won).length,k=h>0?(f/h*100).toFixed(2):"0.00",l={};return d.forEach(e=>{l[e.camp]||(l[e.camp]={appearances:0,wins:0,winRate:"0.00"}),l[e.camp].appearances++,e.won&&l[e.camp].wins++}),Object.keys(l).forEach(e=>{const t=l[e];t.winRate=t.appearances>0?(t.wins/t.appearances*100).toFixed(2):"0.00"}),{playerName:c,totalGames:h,totalWins:f,winRate:k,games:d,campStats:l}},[c,x,o]),isLoading:b||T,error:m||A}}function se(){const{navigateToGameDetails:c,navigationState:x,updateNavigationState:b}=V(),m=x.selectedPlayerName||"Ponce",o=x.groupingMethod||"session",T=e=>{b({selectedPlayerName:e})},A=e=>{b({groupingMethod:e})},{data:C}=W(),{data:n,isLoading:N,error:S}=Y(m),$=v.useMemo(()=>C?.playerStats?C.playerStats.filter(e=>e.gamesPlayed>0).map(e=>e.player).sort():["Ponce"],[C]),g=v.useMemo(()=>{if(!n?.games)return new Map;const e=new Map;return n.games.forEach(t=>{if(!e.has(t.date)){const a=t.date.split("/");a.length===3?e.set(t.date,new Date(parseInt(a[2]),parseInt(a[1])-1,parseInt(a[0])).getTime()):e.set(t.date,new Date(t.date).getTime())}}),e},[n?.games]),d=v.useMemo(()=>{if(!n?.games)return[];const e={};return n.games.forEach(t=>{let a;if(o==="month"){const s=t.date.split("/");s.length===3?a=`${s[1]}/${s[2]}`:a=t.date}else a=t.date;e[a]||(e[a]={games:[],wins:0,total:0}),e[a].games.push(t),e[a].total++,t.won&&e[a].wins++}),Object.entries(e).map(([t,a])=>({period:t,totalGames:a.total,victories:a.wins,defeats:a.total-a.wins,winRate:a.total>0?(a.wins/a.total*100).toFixed(1):"0.0",winRateNum:a.total>0?a.wins/a.total*100:0})).sort((t,a)=>{if(o==="month"){const[s,i]=t.period.split("/"),[p,u]=a.period.split("/"),j=new Date(parseInt(i),parseInt(s)-1,1),y=new Date(parseInt(u),parseInt(p)-1,1);return j.getTime()-y.getTime()}else{const s=g.get(t.period)||0,i=g.get(a.period)||0;return s-i}})},[n,o,g]),h=v.useMemo(()=>n?.campStats?Object.entries(n.campStats).map(([e,t])=>({name:e,value:t.appearances,winRate:t.winRate,wins:t.wins,percentage:(t.appearances/n.totalGames*100).toFixed(1)})):[],[n]),f=v.useMemo(()=>{if(!h.length)return[];const e=5;let t=0;const a=[],s=[];if(h.forEach(i=>{parseFloat(i.percentage)<e?(t+=Number(i.value),a.push(i)):s.push(i)}),t>0){const i=h.reduce((p,u)=>p+Number(u.value),0);s.push({name:"Autres",value:t,winRate:"0.0",wins:a.reduce((p,u)=>p+u.wins,0),percentage:(t/i*100).toFixed(1),_details:a})}return s},[h]),l=(e=>e<=15?{fontSize:11,angle:-45,height:80,interval:0}:e<=30?{fontSize:10,angle:-45,height:85,interval:1}:e<=50?{fontSize:9,angle:-60,height:95,interval:2}:{fontSize:8,angle:-75,height:105,interval:Math.floor(e/12)})(d.length);return N?r.jsx("div",{className:"donnees-attente",children:"Chargement de l'historique du joueur..."}):S?r.jsxs("div",{className:"donnees-probleme",children:["Erreur: ",S]}):n?r.jsxs("div",{className:"lycans-player-history",children:[r.jsx("h2",{children:"Historique Détaillé d'un Joueur"}),r.jsxs("div",{className:"lycans-controls-section",style:{display:"flex",gap:"2rem",marginBottom:"2rem",justifyContent:"center",flexWrap:"wrap"},children:[r.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[r.jsx("label",{htmlFor:"player-select",style:{color:"var(--text-secondary)",fontSize:"0.9rem"},children:"Joueur:"}),r.jsx("select",{id:"player-select",value:m,onChange:e=>T(e.target.value),style:{background:"var(--bg-tertiary)",color:"var(--text-primary)",border:"1px solid var(--border-color)",borderRadius:"4px",padding:"0.5rem",fontSize:"0.9rem",minWidth:"120px"},children:$.map(e=>r.jsx("option",{value:e,children:e},e))})]}),r.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[r.jsx("label",{htmlFor:"grouping-select",style:{color:"var(--text-secondary)",fontSize:"0.9rem"},children:"Groupement:"}),r.jsxs("select",{id:"grouping-select",value:o,onChange:e=>A(e.target.value),style:{background:"var(--bg-tertiary)",color:"var(--text-primary)",border:"1px solid var(--border-color)",borderRadius:"4px",padding:"0.5rem",fontSize:"0.9rem",minWidth:"120px"},children:[r.jsx("option",{value:"session",children:"Par session"}),r.jsx("option",{value:"month",children:"Par mois"})]})]})]}),r.jsxs("div",{className:"lycans-resume-conteneur",children:[r.jsxs("div",{className:"lycans-stat-carte",children:[r.jsx("h3",{children:"Total Parties"}),r.jsx("div",{className:"lycans-valeur-principale",children:n.totalGames}),r.jsx("p",{children:"parties jouées"})]}),r.jsxs("div",{className:"lycans-stat-carte",children:[r.jsx("h3",{children:"Victoires"}),r.jsx("div",{className:"lycans-valeur-principale",children:n.totalWins}),r.jsx("p",{children:"parties gagnées"})]}),r.jsxs("div",{className:"lycans-stat-carte",children:[r.jsx("h3",{children:"Taux de Victoire"}),r.jsxs("div",{className:"lycans-valeur-principale",children:[n.winRate,"%"]}),r.jsx("p",{children:"pourcentage global"})]})]}),r.jsxs("div",{className:"lycans-graphiques-groupe",children:[r.jsxs("div",{className:"lycans-graphique-section",children:[r.jsxs("h3",{children:["Évolution des Performances ",o==="month"?"par Mois":"par Session"]}),r.jsx(z,{title:`Évolution des Performances ${o==="month"?"par Mois":"par Session"}`,children:r.jsx("div",{style:{height:400},children:r.jsx(w,{width:"100%",height:"100%",children:r.jsxs(_,{data:d,margin:{top:20,right:30,left:20,bottom:60},onClick:e=>{if(e&&e.activeLabel){const t=d.find(a=>a.period===e.activeLabel);t&&c({selectedPlayer:m,selectedDate:t.period,fromComponent:`Évolution des Performances ${o==="month"?"par Mois":"par Session"}`})}},style:{cursor:"pointer"},children:[r.jsx(G,{strokeDasharray:"3 3"}),r.jsx(L,{dataKey:"period",angle:l.angle,textAnchor:"end",height:l.height,interval:l.interval,fontSize:l.fontSize}),r.jsx(M,{label:{value:"Taux de victoire (%)",angle:-90,position:"insideLeft"},domain:[0,100]}),r.jsx(D,{content:({active:e,payload:t})=>{if(e&&t&&t.length>0){const a=t[0].payload;return r.jsxs("div",{style:{background:"var(--bg-secondary)",color:"var(--text-primary)",padding:12,borderRadius:8,border:"1px solid var(--border-color)"},children:[r.jsx("div",{children:r.jsx("strong",{children:a.period})}),r.jsxs("div",{children:["Parties: ",a.totalGames]}),r.jsxs("div",{children:["Victoires: ",a.victories]}),r.jsxs("div",{children:["Taux: ",a.winRate,"%"]}),r.jsx("div",{style:{fontSize:"0.8rem",color:"var(--chart-color-1)",marginTop:"0.25rem",fontStyle:"italic"},children:"Cliquez pour voir les parties"})]})}return null}}),r.jsx(J,{type:"monotone",dataKey:"winRateNum",stroke:"var(--accent-primary)",strokeWidth:2,dot:{fill:"var(--accent-primary)",strokeWidth:2,r:4}})]})})})})]}),r.jsxs("div",{className:"lycans-graphique-section",children:[r.jsxs("h3",{children:["Répartition Victoires/Défaites ",o==="month"?"par Mois":"par Session"]}),r.jsx(z,{title:`Répartition Victoires/Défaites ${o==="month"?"par Mois":"par Session"}`,children:r.jsx("div",{style:{height:400},children:r.jsx(w,{width:"100%",height:"100%",children:r.jsxs(q,{data:d,margin:{top:20,right:30,left:20,bottom:60},children:[r.jsx(G,{strokeDasharray:"3 3"}),r.jsx(L,{dataKey:"period",angle:l.angle,textAnchor:"end",height:l.height,interval:l.interval,fontSize:l.fontSize}),r.jsx(M,{label:{value:"Nombre de parties",angle:-90,position:"insideLeft"},allowDecimals:!1}),r.jsx(D,{content:({active:e,payload:t})=>{if(e&&t&&t.length>0){const a=t[0].payload;return r.jsxs("div",{style:{background:"var(--bg-secondary)",color:"var(--text-primary)",padding:12,borderRadius:8,border:"1px solid var(--border-color)"},children:[r.jsx("div",{children:r.jsx("strong",{children:a.period})}),r.jsxs("div",{children:["Total: ",a.totalGames," parties"]}),r.jsxs("div",{children:["Victoires: ",a.victories]}),r.jsxs("div",{children:["Défaites: ",a.defeats]}),r.jsxs("div",{children:["Taux: ",a.winRate,"%"]}),r.jsx("div",{style:{fontSize:"0.8rem",color:"var(--chart-color-1)",marginTop:"0.25rem",fontStyle:"italic"},children:"Cliquez pour voir les parties"})]})}return null}}),r.jsx(R,{dataKey:"victories",stackId:"games",fill:"var(--accent-tertiary)",name:"Victoires",children:d.map((e,t)=>r.jsx(P,{fill:"var(--accent-tertiary)",onClick:()=>{c({selectedPlayer:m,selectedDate:e.period,fromComponent:`Historique Joueur - Victoires ${o==="month"?"par Mois":"par Session"}`})},style:{cursor:"pointer"}},`cell-victories-${t}`))}),r.jsx(R,{dataKey:"defeats",stackId:"games",fill:"var(--chart-color-4)",name:"Défaites",children:d.map((e,t)=>r.jsx(P,{fill:"var(--chart-color-4)",onClick:()=>{c({selectedPlayer:m,selectedDate:e.period,fromComponent:`Historique Joueur - Défaites ${o==="month"?"par Mois":"par Session"}`})},style:{cursor:"pointer"}},`cell-defeats-${t}`))})]})})})})]})]}),r.jsxs("div",{className:"lycans-graphiques-groupe",children:[r.jsxs("div",{className:"lycans-graphique-section",children:[r.jsx("h3",{children:"Distribution par Camps"}),r.jsx("div",{style:{height:400},children:r.jsx(w,{width:"100%",height:"100%",children:r.jsxs(O,{children:[r.jsx(X,{data:f,cx:"50%",cy:"50%",labelLine:!1,outerRadius:120,fill:"#8884d8",dataKey:"value",label:({name:e,value:t,percent:a})=>{const s=a!==void 0?a:0;return e==="Autres"?`Autres : ${t} (${(s*100).toFixed(1)}%)`:`${e}: ${t} (${(s*100).toFixed(1)}%)`},children:f.map((e,t)=>r.jsx(P,{fill:e.name==="Autres"?H:I[e.name]||`var(--chart-color-${t%6+1})`,onClick:()=>{if(e.name==="Autres"){const a=e._details?.map(s=>s.name)||[];c({selectedPlayer:m,selectedCamp:"Autres",_smallCamps:a,fromComponent:"Distribution par Camps"})}else c({selectedPlayer:m,selectedCamp:e.name,fromComponent:"Distribution par Camps"})},style:{cursor:"pointer"}},`cell-${t}`))}),r.jsx(D,{content:({active:e,payload:t})=>{if(e&&t&&t.length>0){const a=t[0].payload;if(a.name==="Autres"&&a._details){const s=[...a._details].sort((i,p)=>p.value-i.value);return r.jsxs("div",{style:{background:"var(--bg-secondary)",color:"var(--text-primary)",padding:12,borderRadius:8,border:"1px solid var(--border-color)"},children:[r.jsx("div",{children:r.jsxs("strong",{children:["Autres - ",a.value," parties (",a.percentage,"%)"]})}),r.jsx("div",{children:s.map((i,p)=>r.jsxs("div",{children:[i.name,": ",i.value," parties (",i.percentage,"%)"]},p))}),r.jsx("div",{style:{fontSize:"0.8rem",color:"var(--chart-color-1)",marginTop:"0.25rem",fontStyle:"italic"},children:"Cliquez pour voir toutes les parties de ces camps"})]})}return r.jsxs("div",{style:{background:"var(--bg-secondary)",color:"var(--text-primary)",padding:12,borderRadius:8,border:"1px solid var(--border-color)"},children:[r.jsx("div",{children:r.jsxs("strong",{children:[a.name," (",a.percentage,"%)"]})}),r.jsxs("div",{children:["Apparitions: ",a.value]}),r.jsxs("div",{children:["Victoires: ",a.wins," (",a.winRate,"%)"]}),r.jsx("div",{style:{fontSize:"0.8rem",color:"var(--chart-color-1)",marginTop:"0.25rem",fontStyle:"italic"},children:"Cliquez pour voir les parties"})]})}return null}})]})})})]}),r.jsxs("div",{className:"lycans-graphique-section",children:[r.jsx("h3",{children:"Performance par Camp"}),r.jsx(z,{title:"Performance par Camp",children:r.jsx("div",{style:{height:400},children:r.jsx(w,{width:"100%",height:"100%",children:r.jsxs(q,{data:h,margin:{top:20,right:30,left:20,bottom:80},children:[r.jsx(G,{strokeDasharray:"3 3"}),r.jsx(L,{dataKey:"name",angle:-45,textAnchor:"end",height:90,interval:0,fontSize:11}),r.jsx(M,{label:{value:"Taux de victoire (%)",angle:-90,position:"insideLeft"},domain:[0,100]}),r.jsx(D,{content:({active:e,payload:t})=>{if(e&&t&&t.length>0){const a=t[0].payload;return r.jsxs("div",{style:{background:"var(--bg-secondary)",color:"var(--text-primary)",padding:12,borderRadius:8,border:"1px solid var(--border-color)"},children:[r.jsx("div",{children:r.jsx("strong",{children:a.name})}),r.jsxs("div",{children:["Victoires: ",a.wins," / ",a.value]}),r.jsxs("div",{children:["Taux: ",a.winRate,"%"]}),r.jsx("div",{style:{fontSize:"0.8rem",color:"var(--chart-color-1)",marginTop:"0.25rem",fontStyle:"italic"},children:"Cliquez pour voir les parties"})]})}return null}}),r.jsx(R,{dataKey:"winRate",children:h.map((e,t)=>r.jsx(P,{fill:I[e.name]||`var(--chart-color-${t%6+1})`,onClick:()=>{c({selectedPlayer:m,selectedCamp:e.name,fromComponent:"Performance par Camp"})},style:{cursor:"pointer"}},`cell-${t}`))})]})})})})]})]})]}):r.jsx("div",{className:"donnees-manquantes",children:"Aucune donnée d'historique disponible"})}export{se as PlayerGameHistoryChart};
