import{r as w,j as r,a as he,u as se,e as ie}from"./index-DSkcnwZv.js";import{d as me,e as J,u as ge,c as pe}from"./useDeathStatisticsFromRaw-C-EJ7TiQ.js";import{D as O}from"./datasyncExport-D6_8Fmuy.js";import{a as xe}from"./api-BwxSCv3v.js";import{c as ye,r as ve,C as be,X as je,Y as Me,a as we,F as Se}from"./FullscreenChart-i_JP2HRK.js";import{g as F}from"./deathTypes-CGUOTngO.js";import{ak as Ee,w as Ce,al as ze,am as Ae,an as Pe,H as ke,u as Q,ao as ee,L as Ie,c as Re,s as De,ap as Oe,aq as Le,ar as Y,as as Ne,at as le,au as te,av as Ve,aw as q,R as We,T as Be}from"./CategoricalChart-GM5xvVBQ.js";import{S as Xe,a as Te}from"./ScatterChart-BWagTpcm.js";import"./baseStatsHook-Chs-G3lE.js";const Fe=He(Ye);function He(e){return function(t,n,o=n){if(!((n=+n)>=0))throw new RangeError("invalid rx");if(!((o=+o)>=0))throw new RangeError("invalid ry");let{data:a,width:d,height:f}=t;if(!((d=Math.floor(d))>=0))throw new RangeError("invalid width");if(!((f=Math.floor(f!==void 0?f:a.length/d))>=0))throw new RangeError("invalid height");if(!d||!f||!n&&!o)return t;const p=n&&e(n),j=o&&e(o),l=a.slice();return p&&j?(B(p,l,a,d,f),B(p,a,l,d,f),B(p,l,a,d,f),X(j,a,l,d,f),X(j,l,a,d,f),X(j,a,l,d,f)):p?(B(p,a,l,d,f),B(p,l,a,d,f),B(p,a,l,d,f)):j&&(X(j,a,l,d,f),X(j,l,a,d,f),X(j,a,l,d,f)),t}}function B(e,t,n,o,a){for(let d=0,f=o*a;d<f;)e(t,n,d,d+=o,1)}function X(e,t,n,o,a){for(let d=0,f=o*a;d<o;++d)e(t,n,d,d+f,o)}function Ye(e){const t=Math.floor(e);if(t===e)return qe(e);const n=e-t,o=2*e+1;return(a,d,f,p,j)=>{if(!((p-=j)>=f))return;let l=t*d[f];const c=j*t,v=c+j;for(let x=f,i=f+c;x<i;x+=j)l+=d[Math.min(p,x)];for(let x=f,i=p;x<=i;x+=j)l+=d[Math.min(p,x+c)],a[x]=(l+n*(d[Math.max(f,x-v)]+d[Math.min(p,x+v)]))/o,l-=d[Math.max(f,x-c)]}}function qe(e){const t=2*e+1;return(n,o,a,d,f)=>{if(!((d-=f)>=a))return;let p=e*o[a];const j=f*e;for(let l=a,c=a+j;l<c;l+=f)p+=o[Math.min(d,l)];for(let l=a,c=d;l<=c;l+=f)p+=o[Math.min(d,l+j)],n[l]=p/t,p-=o[Math.max(a,l-j)]}}function $e(e,t){let n=0;for(let o of e)o!=null&&(o=+o)>=o&&++n;return n}function Ge(e,t){let n,o;if(t===void 0)for(const a of e)a!=null&&(n===void 0?a>=a&&(n=o=a):(n>a&&(n=a),o<a&&(o=a)));else{let a=-1;for(let d of e)(d=t(d,++a,e))!=null&&(n===void 0?d>=d&&(n=o=d):(n>d&&(n=d),o<d&&(o=d)))}return[n,o]}function Ze(e,t,n){let o;for(;;){const a=Ee(e,t,n);if(a===o||a===0||!isFinite(a))return[e,t];a>0?(e=Math.floor(e/a)*a,t=Math.ceil(t/a)*a):a<0&&(e=Math.ceil(e*a)/a,t=Math.floor(t*a)/a),o=a}}function Ue(e){return Math.max(1,Math.ceil(Math.log($e(e))/Math.LN2)+1)}function re(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter(function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable})),n.push.apply(n,o)}return n}function ne(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?re(Object(n),!0).forEach(function(o){K(e,o,n[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):re(Object(n)).forEach(function(o){Object.defineProperty(e,o,Object.getOwnPropertyDescriptor(n,o))})}return e}function K(e,t,n){return(t=Ke(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Ke(e){var t=_e(e,"string");return typeof t=="symbol"?t:t+""}function _e(e,t){if(typeof e!="object"||!e)return e;var n=e[Symbol.toPrimitive];if(n!==void 0){var o=n.call(e,t);if(typeof o!="object")return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return(t==="string"?String:Number)(e)}function U(){return U=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)({}).hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e},U.apply(null,arguments)}var Je=(e,t,n,o,a,d,f)=>{var{x1:p,x2:j,y1:l,y2:c}=f;if(a==null||d==null)return null;var v=ye({x:a,y:d}),x={x:e?v.x.apply(p,{position:"start"}):v.x.rangeMin,y:n?v.y.apply(l,{position:"start"}):v.y.rangeMin},i={x:t?v.x.apply(j,{position:"end"}):v.x.rangeMax,y:o?v.y.apply(c,{position:"end"}):v.y.rangeMax};return f.ifOverflow==="discard"&&(!v.isInRange(x)||!v.isInRange(i))?null:ve(x,i)},Qe=(e,t)=>{var n;return w.isValidElement(e)?n=w.cloneElement(e,t):typeof e=="function"?n=e(t):n=w.createElement(Ne,U({},t,{className:"recharts-reference-area-rect"})),n};function et(e){var t=Ce();return w.useEffect(()=>(t(ze(e)),()=>{t(Ae(e))})),null}function tt(e){var{x1:t,x2:n,y1:o,y2:a,className:d,shape:f,xAxisId:p,yAxisId:j}=e,l=Pe(),c=ke(),v=Q(g=>ee(g,"xAxis",p,c)),x=Q(g=>ee(g,"yAxis",j,c));if(v==null||!x==null)return null;var i=Y(t),y=Y(n),b=Y(o),S=Y(a);if(!i&&!y&&!b&&!S&&!f)return null;var A=Je(i,y,b,S,v,x,e);if(!A&&!f)return null;var h=e.ifOverflow==="hidden",P=h?"url(#".concat(l,")"):void 0;return w.createElement(Ie,{className:Re("recharts-reference-area",d)},Qe(f,ne(ne({clipPath:P},De(e)),A)),w.createElement(Oe,A,w.createElement(Le,{label:e.label}),e.children))}function rt(e){return w.createElement(w.Fragment,null,w.createElement(et,{yAxisId:e.yAxisId,xAxisId:e.xAxisId,ifOverflow:e.ifOverflow,x1:e.x1,x2:e.x2,y1:e.y1,y2:e.y2}),w.createElement(tt,e))}class _ extends w.Component{render(){return w.createElement(rt,this.props)}}K(_,"displayName","ReferenceArea");K(_,"defaultProps",{ifOverflow:"discard",xAxisId:0,yAxisId:0,r:10,fill:"#ccc",fillOpacity:.5,stroke:"none",strokeWidth:1});var nt=Array.prototype,ce=nt.slice;function at(e,t){return e-t}function ot(e){for(var t=0,n=e.length,o=e[n-1][1]*e[0][0]-e[n-1][0]*e[0][1];++t<n;)o+=e[t-1][1]*e[t][0]-e[t-1][0]*e[t][1];return o}const V=e=>()=>e;function st(e,t){for(var n=-1,o=t.length,a;++n<o;)if(a=it(e,t[n]))return a;return 0}function it(e,t){for(var n=t[0],o=t[1],a=-1,d=0,f=e.length,p=f-1;d<f;p=d++){var j=e[d],l=j[0],c=j[1],v=e[p],x=v[0],i=v[1];if(lt(j,v,t))return 0;c>o!=i>o&&n<(x-l)*(o-c)/(i-c)+l&&(a=-a)}return a}function lt(e,t,n){var o;return ct(e,t,n)&&dt(e[o=+(e[0]===t[0])],n[o],t[o])}function ct(e,t,n){return(t[0]-e[0])*(n[1]-e[1])===(n[0]-e[0])*(t[1]-e[1])}function dt(e,t,n){return e<=t&&t<=n||n<=t&&t<=e}function ut(){}var L=[[],[[[1,1.5],[.5,1]]],[[[1.5,1],[1,1.5]]],[[[1.5,1],[.5,1]]],[[[1,.5],[1.5,1]]],[[[1,1.5],[.5,1]],[[1,.5],[1.5,1]]],[[[1,.5],[1,1.5]]],[[[1,.5],[.5,1]]],[[[.5,1],[1,.5]]],[[[1,1.5],[1,.5]]],[[[.5,1],[1,.5]],[[1.5,1],[1,1.5]]],[[[1.5,1],[1,.5]]],[[[.5,1],[1.5,1]]],[[[1,1.5],[1.5,1]]],[[[.5,1],[1,1.5]]],[]];function ae(){var e=1,t=1,n=Ue,o=j;function a(l){var c=n(l);if(Array.isArray(c))c=c.slice().sort(at);else{const v=Ge(l,ft);for(c=le(...Ze(v[0],v[1],c),c);c[c.length-1]>=v[1];)c.pop();for(;c[1]<v[0];)c.shift()}return c.map(v=>d(l,v))}function d(l,c){const v=c==null?NaN:+c;if(isNaN(v))throw new Error(`invalid value: ${c}`);var x=[],i=[];return f(l,v,function(y){o(y,l,v),ot(y)>0?x.push([y]):i.push(y)}),i.forEach(function(y){for(var b=0,S=x.length,A;b<S;++b)if(st((A=x[b])[0],y)!==-1){A.push(y);return}}),{type:"MultiPolygon",value:c,coordinates:x}}function f(l,c,v){var x=new Array,i=new Array,y,b,S,A,h,P;for(y=b=-1,A=W(l[0],c),L[A<<1].forEach(g);++y<e-1;)S=A,A=W(l[y+1],c),L[S|A<<1].forEach(g);for(L[A<<0].forEach(g);++b<t-1;){for(y=-1,A=W(l[b*e+e],c),h=W(l[b*e],c),L[A<<1|h<<2].forEach(g);++y<e-1;)S=A,A=W(l[b*e+e+y+1],c),P=h,h=W(l[b*e+y+1],c),L[S|A<<1|h<<2|P<<3].forEach(g);L[A|h<<3].forEach(g)}for(y=-1,h=l[b*e]>=c,L[h<<2].forEach(g);++y<e-1;)P=h,h=W(l[b*e+y+1],c),L[h<<2|P<<3].forEach(g);L[h<<3].forEach(g);function g(C){var z=[C[0][0]+y,C[0][1]+b],m=[C[1][0]+y,C[1][1]+b],M=p(z),u=p(m),s,E;(s=i[M])?(E=x[u])?(delete i[s.end],delete x[E.start],s===E?(s.ring.push(m),v(s.ring)):x[s.start]=i[E.end]={start:s.start,end:E.end,ring:s.ring.concat(E.ring)}):(delete i[s.end],s.ring.push(m),i[s.end=u]=s):(s=x[u])?(E=i[M])?(delete x[s.start],delete i[E.end],s===E?(s.ring.push(m),v(s.ring)):x[E.start]=i[s.end]={start:E.start,end:s.end,ring:E.ring.concat(s.ring)}):(delete x[s.start],s.ring.unshift(z),x[s.start=M]=s):x[M]=i[u]={start:M,end:u,ring:[z,m]}}}function p(l){return l[0]*2+l[1]*(e+1)*4}function j(l,c,v){l.forEach(function(x){var i=x[0],y=x[1],b=i|0,S=y|0,A=Z(c[S*e+b]);i>0&&i<e&&b===i&&(x[0]=oe(i,Z(c[S*e+b-1]),A,v)),y>0&&y<t&&S===y&&(x[1]=oe(y,Z(c[(S-1)*e+b]),A,v))})}return a.contour=d,a.size=function(l){if(!arguments.length)return[e,t];var c=Math.floor(l[0]),v=Math.floor(l[1]);if(!(c>=0&&v>=0))throw new Error("invalid size");return e=c,t=v,a},a.thresholds=function(l){return arguments.length?(n=typeof l=="function"?l:Array.isArray(l)?V(ce.call(l)):V(l),a):n},a.smooth=function(l){return arguments.length?(o=l?j:ut,a):o===j},a}function ft(e){return isFinite(e)?e:NaN}function W(e,t){return e==null?!1:+e>=t}function Z(e){return e==null||isNaN(e=+e)?-1/0:e}function oe(e,t,n,o){const a=o-t,d=n-t,f=isFinite(a)||isFinite(d)?a/d:Math.sign(a)/Math.sign(d);return isNaN(f)?e:e+f-.5}function ht(e){return e[0]}function mt(e){return e[1]}function gt(){return 1}function pt(){var e=ht,t=mt,n=gt,o=960,a=500,d=20,f=2,p=d*3,j=o+p*2>>f,l=a+p*2>>f,c=V(20);function v(h){var P=new Float32Array(j*l),g=Math.pow(2,-f),C=-1;for(const R of h){var z=(e(R,++C,h)+p)*g,m=(t(R,C,h)+p)*g,M=+n(R,C,h);if(M&&z>=0&&z<j&&m>=0&&m<l){var u=Math.floor(z),s=Math.floor(m),E=z-u-.5,I=m-s-.5;P[u+s*j]+=(1-E)*(1-I)*M,P[u+1+s*j]+=E*(1-I)*M,P[u+1+(s+1)*j]+=E*I*M,P[u+(s+1)*j]+=(1-E)*I*M}}return Fe({data:P,width:j,height:l},d*g),P}function x(h){var P=v(h),g=c(P),C=Math.pow(2,2*f);return Array.isArray(g)||(g=le(Number.MIN_VALUE,te(P)/C,g)),ae().size([j,l]).thresholds(g.map(z=>z*C))(P).map((z,m)=>(z.value=+g[m],i(z)))}x.contours=function(h){var P=v(h),g=ae().size([j,l]),C=Math.pow(2,2*f),z=m=>{m=+m;var M=i(g.contour(P,m*C));return M.value=m,M};return Object.defineProperty(z,"max",{get:()=>te(P)/C}),z};function i(h){return h.coordinates.forEach(y),h}function y(h){h.forEach(b)}function b(h){h.forEach(S)}function S(h){h[0]=h[0]*Math.pow(2,f)-p,h[1]=h[1]*Math.pow(2,f)-p}function A(){return p=d*3,j=o+p*2>>f,l=a+p*2>>f,x}return x.x=function(h){return arguments.length?(e=typeof h=="function"?h:V(+h),x):e},x.y=function(h){return arguments.length?(t=typeof h=="function"?h:V(+h),x):t},x.weight=function(h){return arguments.length?(n=typeof h=="function"?h:V(+h),x):n},x.size=function(h){if(!arguments.length)return[o,a];var P=+h[0],g=+h[1];if(!(P>=0&&g>=0))throw new Error("invalid size");return o=P,a=g,A()},x.cellSize=function(h){if(!arguments.length)return 1<<f;if(!((h=+h)>=1))throw new Error("invalid cell size");return f=Math.floor(Math.log(h)/Math.LN2),A()},x.thresholds=function(h){return arguments.length?(c=typeof h=="function"?h:Array.isArray(h)?V(ce.call(h)):V(h),x):c},x.bandwidth=function(h){if(!arguments.length)return Math.sqrt(d*(d+1));if(!((h=+h)>=0))throw new Error("invalid bandwidth");return d=(Math.sqrt(4*h*h+1)-1)/2,A()},x}function xt(e){for(var t=e.length/6|0,n=new Array(t),o=0;o<t;)n[o]="#"+e.slice(o*6,++o*6);return n}const yt=e=>Ve(e[e.length-1]);var vt=new Array(3).concat("ffeda0feb24cf03b20","ffffb2fecc5cfd8d3ce31a1c","ffffb2fecc5cfd8d3cf03b20bd0026","ffffb2fed976feb24cfd8d3cf03b20bd0026","ffffb2fed976feb24cfd8d3cfc4e2ae31a1cb10026","ffffccffeda0fed976feb24cfd8d3cfc4e2ae31a1cb10026","ffffccffeda0fed976feb24cfd8d3cfc4e2ae31a1cbd0026800026").map(xt);const bt=yt(vt),jt={Village:{name:"Village",imagePath:"/Village.webp",cameraOffset:{x:185,y:52.78,z:183},offsetMultiplier:3.2,manualOffsetX:0,manualOffsetY:0,imageWidth:900,imageHeight:512}},Mt={Village:{name:"Village",imagePath:"/Village.webp",cameraOffset:{x:164,y:52.78,z:175},offsetMultiplier:3,manualOffsetX:0,manualOffsetY:0,imageWidth:900,imageHeight:512}};function H(e,t,n){const{cameraOffset:o,offsetMultiplier:a,imageWidth:d,imageHeight:f,manualOffsetX:p=0,manualOffsetY:j=0}=n,l=(e-o.x)*a+d/2+p,c=(t-o.z)*a+f/2+j;return{x:l,y:c}}function de(e,t){if(e.length===0)return{minX:0,maxX:100,minY:0,maxY:100,width:100,height:100};const n=e.map(p=>H(p.x,p.z,t)),o=Math.min(...n.map(p=>p.x)),a=Math.max(...n.map(p=>p.x)),d=Math.min(...n.map(p=>p.y)),f=Math.max(...n.map(p=>p.y));return{minX:o,maxX:a,minY:d,maxY:f,width:a-o,height:f-d}}function ue(e,t="heatmap"){return(t==="scatter"?jt:Mt)[e]||null}function wt({deathLocations:e,xDomain:t,zDomain:n,mapName:o,width:a,height:d,bandwidth:f=25,onRegionClick:p}){const j=w.useRef(null),l=w.useRef(null),c=w.useRef(null),v=w.useRef(null),[x,i]=w.useState(null),y=w.useMemo(()=>ue(o,"heatmap"),[o]),b=y?.imageWidth??a??800,S=y?.imageHeight??d??600,A=w.useMemo(()=>y?de(e,y):null,[y,e]),h=w.useMemo(()=>y&&A?q().domain([0,y.imageWidth]).range([0,b]):q().domain(t).range([0,b]),[y,A,t,b]),P=w.useMemo(()=>y&&A?q().domain([0,y.imageHeight]).range([0,S]):q().domain(n).range([S,0]),[y,A,n,S]);w.useEffect(()=>{if(!y){i(null);return}const u=new Image;u.onload=()=>i(u),u.onerror=()=>{console.error(`Failed to load map image: ${y.imagePath}`),i(null)},u.src=y.imagePath},[y]);const g=w.useMemo(()=>y?e.map(u=>{const s=H(u.x,u.z,y);return{...u,screenX:s.x,screenY:s.y}}):e,[e,y]),C=w.useMemo(()=>g.length===0?[]:pt().x(s=>h(y?s.screenX:s.x)).y(s=>P(y?s.screenY:s.z)).size([b,S]).bandwidth(f).thresholds(15)(g),[g,h,P,b,S,f,y]),z=w.useMemo(()=>{const u=C.length>0?Math.max(...C.map(s=>s.value)):1;return s=>{const E=s/u;return bt(E)}},[C]);w.useEffect(()=>{const u=c.current;if(!u)return;const s=u.getContext("2d");s&&(s.clearRect(0,0,b,S),x&&y?(s.drawImage(x,0,0,b,S),s.fillStyle="rgba(0, 0, 0, 0.1)",s.fillRect(0,0,b,S)):(s.fillStyle="var(--bg-tertiary)",s.fillRect(0,0,b,S)))},[x,y,b,S]),w.useEffect(()=>{const u=j.current;if(!u||C.length===0)return;const s=u.getContext("2d");s&&(s.clearRect(0,0,b,S),C.forEach(E=>{s.fillStyle=z(E.value),s.globalAlpha=.6,E.coordinates.forEach(I=>{I.forEach(R=>{s.beginPath(),R.forEach((D,k)=>{k===0?s.moveTo(D[0],D[1]):s.lineTo(D[0],D[1])}),s.closePath(),s.fill()})})}),s.globalAlpha=1)},[C,b,S,z]),w.useEffect(()=>{const u=l.current;if(!u||g.length===0)return;const s=u.getContext("2d");s&&(s.clearRect(0,0,b,S),g.forEach(E=>{const I=h(y?E.screenX:E.x),R=P(y?E.screenY:E.z);s.beginPath(),s.arc(I,R,3,0,2*Math.PI),s.fillStyle="rgba(255, 50, 50, 0.8)",s.fill(),s.strokeStyle="rgba(255, 255, 255, 0.8)",s.lineWidth=1,s.stroke()}))},[g,h,P,b,S,y]);const m=u=>{if(!p||!v.current)return;const s=v.current.getBoundingClientRect(),E=u.clientX-s.left,I=u.clientY-s.top,R=30,D=e.filter((k,N)=>{const T=g[N],$=h(y?T.screenX:k.x),G=P(y?T.screenY:k.z);return Math.sqrt(Math.pow($-E,2)+Math.pow(G-I,2))<=R});D.length>0&&p(D)},M=u=>{if(!v.current)return;const s=v.current.getBoundingClientRect(),E=u.clientX-s.left,I=u.clientY-s.top,R=20,D=e.filter((k,N)=>{const T=g[N],$=h(y?T.screenX:k.x),G=P(y?T.screenY:k.z);return Math.sqrt(Math.pow($-E,2)+Math.pow(G-I,2))<=R});v.current&&(v.current.style.cursor=D.length>0?"pointer":"default")};return r.jsxs("div",{ref:v,style:{position:"relative",width:`${b}px`,height:`${S}px`,margin:"0 auto"},onClick:m,onMouseMove:M,children:[r.jsx("canvas",{ref:c,width:b,height:S,style:{position:"absolute",top:0,left:0,border:"1px solid var(--border-color)",borderRadius:"4px"}}),r.jsx("canvas",{ref:j,width:b,height:S,style:{position:"absolute",top:0,left:0,pointerEvents:"none"}}),r.jsx("canvas",{ref:l,width:b,height:S,style:{position:"absolute",top:0,left:0,pointerEvents:"none"}}),r.jsx("div",{style:{position:"absolute",bottom:"-30px",left:"50%",transform:"translateX(-50%)",color:"var(--text-secondary)",fontSize:"0.9rem",fontWeight:"bold"},children:"Position X"}),r.jsx("div",{style:{position:"absolute",left:"-50px",top:"50%",transform:"translateY(-50%) rotate(-90deg)",color:"var(--text-secondary)",fontSize:"0.9rem",fontWeight:"bold"},children:"Position Z"}),r.jsxs("svg",{width:b,height:S,style:{position:"absolute",top:0,left:0,pointerEvents:"none"},children:[[0,.25,.5,.75,1].map(u=>{const s=b*u,E=t[0]+(t[1]-t[0])*u;return r.jsxs("g",{children:[r.jsx("line",{x1:s,y1:S,x2:s,y2:S-5,stroke:"var(--text-secondary)",strokeWidth:1}),r.jsx("text",{x:s,y:S-10,textAnchor:"middle",fill:"var(--text-secondary)",fontSize:"0.75rem",children:Math.round(E)})]},`x-${u}`)}),[0,.25,.5,.75,1].map(u=>{const s=S*(1-u),E=n[0]+(n[1]-n[0])*u;return r.jsxs("g",{children:[r.jsx("line",{x1:0,y1:s,x2:5,y2:s,stroke:"var(--text-secondary)",strokeWidth:1}),r.jsx("text",{x:10,y:s,dominantBaseline:"middle",fill:"var(--text-secondary)",fontSize:"0.75rem",children:Math.round(E)})]},`z-${u}`)})]})]})}function St({deathLocations:e,aggregatedLocationData:t,mapName:n,xDomain:o,zDomain:a,onDeathClick:d,CustomTooltip:f,getDeathColor:p}){const{settings:j}=he(),[l,c]=w.useState(null),[v,x]=w.useState(null),i=w.useMemo(()=>ue(n,"scatter"),[n]);w.useEffect(()=>{if(!i){x(null);return}const g=new Image;g.onload=()=>x(g),g.onerror=()=>{console.error(`Failed to load map image: ${i.imagePath}`),x(null)},g.src=i.imagePath},[i]);const y=w.useMemo(()=>i?de(e,i):null,[i,e]),b=w.useMemo(()=>i?t.map(C=>{const z=H(C.x,C.z,i);return{...C,x:z.x,y:z.y}}):t,[t,i]),{effectiveXDomain:S,effectiveZDomain:A}=w.useMemo(()=>i&&y?{effectiveXDomain:[()=>0,()=>i.imageWidth],effectiveZDomain:[()=>0,()=>i.imageHeight]}:{effectiveXDomain:o,effectiveZDomain:a},[i,y,o,a]),h=w.useMemo(()=>[0,.25,.5,.75,1].map(g=>{const C=o[0]+(o[1]-o[0])*g,z=i?H(C,0,i).x:C;return{worldValue:C,screenValue:z}}),[o,i]),P=w.useMemo(()=>[0,.25,.5,.75,1].map(g=>{const C=a[0]+(a[1]-a[0])*g,z=i?H(0,C,i).y:C;return{worldValue:C,screenValue:z}}),[a,i]);return r.jsx("div",{style:{height:700,position:"relative"},children:r.jsx(We,{width:"100%",height:"100%",children:r.jsxs(Xe,{margin:{top:20,right:30,left:60,bottom:60},children:[r.jsx("defs",{children:v&&i&&r.jsx("pattern",{id:`map-pattern-${n}`,x:"0",y:"0",width:"1",height:"1",children:r.jsx("image",{href:i.imagePath,x:"0",y:"0",width:i.imageWidth,height:i.imageHeight,preserveAspectRatio:"none",opacity:"0.3"})})}),v&&i&&r.jsx(_,{x1:0,x2:i.imageWidth,y1:0,y2:i.imageHeight,fill:`url(#map-pattern-${n})`,fillOpacity:1}),r.jsx(be,{strokeDasharray:"3 3",stroke:"var(--border-color)"}),r.jsx(je,{dataKey:"x",type:"number",name:"Position X",label:{value:"Position X",position:"bottom",offset:10,style:{fill:"var(--text-secondary)"}},domain:S,allowDataOverflow:!1,stroke:"var(--text-secondary)",tick:{fill:"var(--text-secondary)"},ticks:h.map(g=>g.screenValue),tickFormatter:g=>{const C=h.reduce((z,m)=>Math.abs(m.screenValue-g)<Math.abs(z.screenValue-g)?m:z);return Math.round(C.worldValue).toString()}}),r.jsx(Me,{dataKey:"y",type:"number",name:"Position Z",label:{value:"Position Z",angle:-90,position:"left",offset:20,style:{fill:"var(--text-secondary)"}},domain:A,allowDataOverflow:!1,stroke:"var(--text-secondary)",tick:{fill:"var(--text-secondary)"},ticks:P.map(g=>g.screenValue),tickFormatter:g=>{const C=P.reduce((z,m)=>Math.abs(m.screenValue-g)<Math.abs(z.screenValue-g)?m:z);return Math.round(C.worldValue).toString()}}),r.jsx(Be,{content:r.jsx(f,{}),cursor:{strokeDasharray:"3 3"}}),r.jsx(Te,{data:b,onClick:g=>d(g),onMouseEnter:g=>c(g),onMouseLeave:()=>c(null),style:{cursor:"pointer"},children:b.map((g,C)=>{const z=j.highlightedPlayer===g.playerName,m=l?.playerName===g.playerName&&l?.gameId===g.gameId,M=g.deathCount>1?7:5,u=M+2;return r.jsx(we,{fill:z?"var(--accent-primary)":p(g.deathType),stroke:z||m?"white":g.deathCount>1?"var(--accent-secondary)":"none",strokeWidth:z?3:m?2:g.deathCount>1?1:0,opacity:z?1:.8,r:z?u:m?M+1:M},`cell-${C}`)})})]})})})}function Et({selectedCamp:e,availableDeathTypes:t,deathTypeColors:n}){const{navigateToGameDetails:o}=se(),{data:a,isLoading:d,error:f}=ie(),[p,j]=w.useState(""),[l,c]=w.useState("all"),[v,x]=w.useState("scatter"),i=w.useMemo(()=>{if(!a)return[];const m=me(a),M=J(a,e),u=new Map;return M.forEach(s=>{u.set(s.mapName,(u.get(s.mapName)||0)+1)}),m.sort((s,E)=>{const I=u.get(s)||0;return(u.get(E)||0)-I})},[a,e]),y=i.length>0?i[0]:"";p===""&&y!==""&&j(y);const b=w.useMemo(()=>{if(!a)return[];let m=J(a,e);return p&&(m=m.filter(M=>M.mapName===p)),l!=="all"&&(m=m.filter(M=>M.deathType===l)),m},[a,e,p,l]),S=w.useMemo(()=>{const m=new Map;return b.forEach(M=>{const u=`${Math.round(M.x)}_${Math.round(M.z)}`;m.has(u)||m.set(u,[]),m.get(u).push(M)}),m},[b]),A=w.useMemo(()=>Array.from(S.entries()).map(([m,M])=>({...M[0],deathCount:M.length,allDeaths:M,locationKey:m})),[S]),h=({active:m,payload:M})=>{if(!m||!M||M.length===0)return null;const u=M[0].payload,s=`${Math.round(u.x)}_${Math.round(u.z)}`,E=S.get(s)||[u];if(E.length>1){const R=new Map,D=new Set;return E.forEach(k=>{const N=k.deathType?F(k.deathType):"Inconnu";R.set(N,(R.get(N)||0)+1),D.add(k.gameId)}),r.jsxs("div",{style:{backgroundColor:"var(--bg-secondary)",border:"1px solid var(--border-color)",borderRadius:"6px",padding:"12px",boxShadow:"0 2px 8px rgba(0,0,0,0.2)",maxWidth:"300px"},children:[r.jsxs("div",{style:{fontWeight:"bold",marginBottom:"8px",fontSize:"1rem",color:"var(--accent-primary)"},children:[E.length," morts Ã  cet endroit"]}),r.jsxs("div",{style:{fontSize:"0.9rem",lineHeight:"1.6"},children:[r.jsxs("div",{style:{marginBottom:"8px"},children:[r.jsx("strong",{children:"Position:"})," (",Math.round(u.x),", ",Math.round(u.z),")"]}),r.jsxs("div",{style:{marginBottom:"8px"},children:[r.jsx("strong",{children:"Types de mort:"}),r.jsx("ul",{style:{margin:"4px 0 0 0",paddingLeft:"20px"},children:Array.from(R.entries()).map(([k,N])=>r.jsxs("li",{children:[k," (",N,")"]},k))})]}),r.jsxs("div",{children:[r.jsx("strong",{children:"Parties:"})," ",Array.from(D).filter(k=>k).map(k=>`#${k}`).join(", ")]})]}),r.jsx("div",{style:{marginTop:"8px",paddingTop:"8px",borderTop:"1px solid var(--border-color)",fontSize:"0.8rem",color:"var(--text-secondary)"},children:"Cliquez pour voir une des parties"})]})}return r.jsxs("div",{style:{backgroundColor:"var(--bg-secondary)",border:"1px solid var(--border-color)",borderRadius:"6px",padding:"12px",boxShadow:"0 2px 8px rgba(0,0,0,0.2)",maxWidth:"300px"},children:[r.jsx("div",{style:{fontWeight:"bold",marginBottom:"8px",fontSize:"1rem",color:"var(--accent-primary)"},children:u.playerName}),r.jsxs("div",{style:{fontSize:"0.9rem",lineHeight:"1.6"},children:[r.jsxs("div",{children:[r.jsx("strong",{children:"Camp:"})," ",u.camp]}),r.jsxs("div",{children:[r.jsx("strong",{children:"Type de mort:"})," ",u.deathType?F(u.deathType):"Inconnu"]}),u.killerName&&r.jsxs("div",{children:[r.jsx("strong",{children:"TuÃ© par:"})," ",u.killerName]}),r.jsxs("div",{children:[r.jsx("strong",{children:"Carte:"})," ",u.mapName]}),r.jsxs("div",{children:[r.jsx("strong",{children:"Partie:"})," #",u.gameId]}),r.jsxs("div",{style:{marginTop:"4px",fontSize:"0.85rem",color:"var(--text-secondary)"},children:["Position: (",Math.round(u.x),", ",Math.round(u.z),")"]})]}),r.jsx("div",{style:{marginTop:"8px",paddingTop:"8px",borderTop:"1px solid var(--border-color)",fontSize:"0.8rem",color:"var(--text-secondary)"},children:"Cliquez pour voir les dÃ©tails de la partie"})]})},P=m=>{if(!m)return;const M=m.allDeaths||[m];if(M.length===1)o({selectedGame:M[0].gameId,fromComponent:"Death Location View"});else{const u=M.map(s=>s.gameId).filter(s=>s);o({selectedGameIds:u,fromComponent:"Death Location View"})}},g=m=>m&&n[m]||"var(--text-secondary)",{xDomain:C,zDomain:z}=w.useMemo(()=>{if(A.length===0)return{xDomain:[0,100],zDomain:[0,100]};const m=A.map(k=>k.x),M=A.map(k=>k.z),u=Math.min(...m),s=Math.max(...m),E=Math.min(...M),I=Math.max(...M),R=(s-u)*.1||10,D=(I-E)*.1||10;return{xDomain:[u-R,s+R],zDomain:[E-D,I+D]}},[A]);return d?r.jsx("div",{className:"donnees-attente",children:"Chargement des localisations de mort..."}):f?r.jsxs("div",{className:"donnees-probleme",children:["Erreur: ",f]}):a?r.jsxs("div",{children:[r.jsxs("div",{style:{marginBottom:"1.5rem",display:"flex",alignItems:"center",gap:"1rem",flexWrap:"wrap"},children:[r.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[r.jsx("label",{style:{color:"var(--text-secondary)",fontSize:"0.9rem",fontWeight:"bold"},children:"Mode :"}),r.jsxs("div",{style:{display:"flex",backgroundColor:"var(--bg-tertiary)",borderRadius:"4px",border:"1px solid var(--border-color)",overflow:"hidden"},children:[r.jsx("button",{onClick:()=>x("scatter"),style:{background:v==="scatter"?"var(--accent-primary)":"transparent",color:v==="scatter"?"white":"var(--text-primary)",border:"none",padding:"0.5rem 1rem",fontSize:"0.9rem",cursor:"pointer",fontWeight:v==="scatter"?"bold":"normal",transition:"all 0.2s"},children:"Points"}),r.jsx("button",{onClick:()=>x("heatmap"),style:{background:v==="heatmap"?"var(--accent-primary)":"transparent",color:v==="heatmap"?"white":"var(--text-primary)",border:"none",padding:"0.5rem 1rem",fontSize:"0.9rem",cursor:"pointer",fontWeight:v==="heatmap"?"bold":"normal",transition:"all 0.2s"},children:"Carte de chaleur"})]})]}),r.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[r.jsx("label",{htmlFor:"map-select",style:{color:"var(--text-secondary)",fontSize:"0.9rem",fontWeight:"bold"},children:"Carte :"}),r.jsx("select",{id:"map-select",value:p,onChange:m=>j(m.target.value),style:{background:"var(--bg-tertiary)",color:"var(--text-primary)",border:"1px solid var(--border-color)",borderRadius:"4px",padding:"0.5rem",fontSize:"0.9rem",minWidth:"150px"},children:i.map(m=>r.jsx("option",{value:m,children:m},m))})]}),r.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[r.jsx("label",{htmlFor:"death-type-select",style:{color:"var(--text-secondary)",fontSize:"0.9rem",fontWeight:"bold"},children:"Type de mort :"}),r.jsxs("select",{id:"death-type-select",value:l,onChange:m=>c(m.target.value),style:{background:"var(--bg-tertiary)",color:"var(--text-primary)",border:"1px solid var(--border-color)",borderRadius:"4px",padding:"0.5rem",fontSize:"0.9rem",minWidth:"180px"},children:[r.jsx("option",{value:"all",children:"Tous les types"}),t.map(m=>r.jsx("option",{value:m,children:F(m)},m))]})]})]}),r.jsxs("div",{className:"lycans-resume-conteneur",style:{marginBottom:"2rem"},children:[r.jsxs("div",{className:"lycans-stat-carte",children:[r.jsx("h3",{children:"Morts localisÃ©es"}),r.jsx("div",{className:"lycans-valeur-principale",style:{color:"var(--accent-primary)"},children:b.length})]}),r.jsxs("div",{className:"lycans-stat-carte",children:[r.jsx("h3",{children:"Camp filtrÃ©"}),r.jsx("div",{className:"lycans-valeur-principale",style:{color:"var(--accent-secondary)",fontSize:"1.2rem"},children:e})]}),r.jsxs("div",{className:"lycans-stat-carte",children:[r.jsx("h3",{children:"Type de mort"}),r.jsx("div",{className:"lycans-valeur-principale",style:{color:"var(--chart-color-2)",fontSize:"1.2rem"},children:l==="all"?"Tous":F(l)})]})]}),b.length>0?r.jsx(Se,{title:v==="scatter"?"Carte des Morts":"Carte de Chaleur des Morts",children:v==="scatter"?r.jsx(St,{deathLocations:b,aggregatedLocationData:A,mapName:p,xDomain:C,zDomain:z,onDeathClick:P,CustomTooltip:h,getDeathColor:g}):r.jsx("div",{style:{padding:"2rem 0",display:"flex",justifyContent:"center"},children:r.jsx(wt,{deathLocations:b,xDomain:C,zDomain:z,mapName:p,width:800,height:600,bandwidth:25,onRegionClick:m=>{if(m.length===1)o({selectedGame:m[0].gameId,fromComponent:"Death Location View (Heatmap)"});else{const M=m.map(u=>u.gameId).filter(u=>u);o({selectedGameIds:M,fromComponent:"Death Location View (Heatmap)"})}}})})}):r.jsxs("div",{className:"donnees-manquantes",style:{padding:"2rem",textAlign:"center",backgroundColor:"var(--bg-secondary)",borderRadius:"8px"},children:[r.jsx("p",{style:{fontSize:"1.1rem",marginBottom:"1rem"},children:"Aucune localisation de mort disponible pour les filtres sÃ©lectionnÃ©s"}),r.jsx("p",{style:{fontSize:"0.9rem",color:"var(--text-secondary)"},children:"Les donnÃ©es de position ne sont disponibles que pour les parties rÃ©centes (non-legacy)."})]}),b.length>0&&r.jsxs("div",{style:{marginTop:"2rem",padding:"1rem",backgroundColor:"var(--bg-secondary)",borderRadius:"8px"},children:[r.jsx("h3",{style:{marginBottom:"1rem",color:"var(--text-primary)"},children:"LÃ©gende des types de mort"}),r.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fill, minmax(200px, 1fr))",gap:"0.5rem"},children:t.map(m=>{const M=b.filter(u=>u.deathType===m).length;return M===0?null:r.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",fontSize:"0.9rem"},children:[r.jsx("div",{style:{width:"16px",height:"16px",borderRadius:"50%",backgroundColor:n[m],flexShrink:0}}),r.jsxs("span",{style:{color:"var(--text-primary)"},children:[F(m)," (",M,")"]})]},m)})})]}),r.jsxs("div",{className:"lycans-section-description",style:{marginTop:"1.5rem"},children:[r.jsx("p",{children:r.jsx("strong",{children:"Ã€ propos de cette visualisation :"})}),r.jsxs("ul",{style:{marginTop:"0.5rem",paddingLeft:"1.5rem"},children:[r.jsx("li",{children:"Les positions sont basÃ©es sur les coordonnÃ©es X et Z (vue 2D de la carte)"}),v==="scatter"?r.jsxs(r.Fragment,{children:[r.jsx("li",{children:"Chaque point reprÃ©sente la mort d'un joueur Ã  un endroit prÃ©cis"}),r.jsx("li",{children:"La couleur indique le type de mort (voir lÃ©gende ci-dessus)"}),r.jsxs("li",{children:["Les joueurs en surbrillance sont affichÃ©s en "," ",r.jsx("span",{style:{color:"var(--accent-primary)",fontWeight:"bold"},children:"couleur primaire"})]}),r.jsx("li",{children:"Cliquez sur un point pour voir les dÃ©tails de la partie"}),r.jsx("li",{children:"Survolez un point pour voir les informations dÃ©taillÃ©es"})]}):r.jsxs(r.Fragment,{children:[r.jsx("li",{children:"La carte de chaleur montre les zones de forte densitÃ© de morts (du jaune au rouge)"}),r.jsx("li",{children:"Les points noirs indiquent l'emplacement exact de chaque mort"}),r.jsx("li",{children:"Les zones rouges indiquent une concentration Ã©levÃ©e de morts"}),r.jsx("li",{children:"Cliquez sur une zone pour voir les dÃ©tails des parties associÃ©es"}),r.jsx("li",{children:'Utilisez le mode "Points" pour voir les dÃ©tails individuels par type de mort'})]})]}),r.jsx("p",{style:{marginTop:"0.5rem",fontStyle:"italic",color:"var(--text-secondary)"},children:"Note : Seules les parties rÃ©centes contiennent des donnÃ©es de position. Les parties legacy sont exclues."})]})]}):r.jsx("div",{className:"donnees-manquantes",children:"Aucune donnÃ©e disponible"})}function Lt(){const{navigationState:e,updateNavigationState:t}=se(),[n,o]=w.useState(e.deathLocationState?.selectedCamp||"Tous les camps"),{data:a}=ge(),{data:d}=ie(),f=xe();w.useEffect(()=>{(!e.deathLocationState||e.deathLocationState.selectedCamp!==n)&&t({deathLocationState:{selectedCamp:n}})},[n,e.deathLocationState,t]);const p=w.useMemo(()=>d?pe(d):[],[d]),j=w.useMemo(()=>{const c={};p.forEach(i=>{i===O.BY_WOLF?c[i]=f.Loup:i===O.VOTED?c[i]="var(--chart-color-1)":i===O.BULLET||i===O.BULLET_HUMAN||i===O.BULLET_WOLF?c[i]=f.Chasseur:i===O.BY_ZOMBIE?c[i]=f.Vaudou:i===O.ASSASSIN?c[i]=f.Alchimiste:i===O.AVENGER?c[i]="var(--chart-color-2)":i===O.LOVER_DEATH?c[i]=f.Amoureux:i===O.BY_BEAST?c[i]="var(--chart-color-3)":i===O.SHERIF_SUCCESS&&(c[i]="var(--chart-color-4)")});const v=["var(--accent-primary)","var(--accent-secondary)","var(--accent-tertiary)","#8884d8","#82ca9d","#ffc658","#ff7300","#00c49f","#ffbb28"];let x=0;return p.forEach(i=>{c[i]||(c[i]=v[x%v.length],x++)}),c},[p,f]),l=c=>{o(c),t({deathLocationState:{selectedCamp:c}})};return r.jsxs("div",{className:"lycans-general-stats",children:[r.jsx("h2",{children:"ðŸ—ºï¸ Carte de Chaleur des Morts"}),r.jsx("div",{style:{marginBottom:"1.5rem",display:"flex",alignItems:"center",gap:"1rem",flexWrap:"wrap"},children:r.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[r.jsx("label",{htmlFor:"camp-select",style:{color:"var(--text-secondary)",fontSize:"0.9rem",fontWeight:"bold"},children:"Camp :"}),r.jsx("select",{id:"camp-select",value:n,onChange:c=>l(c.target.value),style:{background:"var(--bg-tertiary)",color:"var(--text-primary)",border:"1px solid var(--border-color)",borderRadius:"4px",padding:"0.5rem",fontSize:"0.9rem",minWidth:"150px"},children:a?.map(c=>r.jsx("option",{value:c,children:c},c))})]})}),r.jsx(Et,{selectedCamp:n,availableDeathTypes:p,deathTypeColors:j})]})}export{Lt as DeathLocationHeatmap};
