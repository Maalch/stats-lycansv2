import{r as g,j as e}from"./index-V1X2dor0.js";import{y as q,z as B,R as C,C as I,X as L,Y as N,T as D,B as E,o as $,p as F,v as K,w as M}from"./api-8Dckg_6n.js";import{u as W}from"./usePlayerStatsFromRaw-BKiOqRFu.js";import{F as k}from"./FullscreenChart-DZpafLtT.js";import{L as H,a as O}from"./LineChart-B64rZKg_.js";import{P as X,a as _}from"./PieChart-_Ew50Y5s.js";function Y(d){const{data:f,isLoading:h,error:P}=q(),{data:u,isLoading:l,error:A}=B();return{data:g.useMemo(()=>{if(!d||d.trim()===""||!f||f.length===0||!u||u.length===0)return null;const j=r=>r?r.split(",").map(i=>i.trim()).filter(Boolean):[],y=(r,i)=>i&&i.trim()!==""?j(i).some(o=>o.toLowerCase()===r.toLowerCase()):!1,b=(r,i,n)=>r[i]&&r[i][n]||"Villageois",m=r=>{if(r instanceof Date){const i=r.getDate().toString().padStart(2,"0"),n=(r.getMonth()+1).toString().padStart(2,"0"),o=r.getFullYear();return`${i}/${n}/${o}`}if(typeof r=="string"){if(/^\d{2}\/\d{2}\/\d{4}$/.test(r))return r;if(/^\d{4}-\d{2}-\d{2}$/.test(r)){const i=r.split("-");return`${i[2]}/${i[1]}/${i[0]}`}}return r?.toString()||""},x={};u.forEach(r=>{const i=r.Game?.toString();if(!i)return;x[i]||(x[i]={});const n=(o,p)=>{o&&j(o.toString()).forEach(S=>{const R=S.trim();R&&(x[i][R]=p)})};n(r.Loups,"Loups"),n(r.Traître,"Traître"),n(r["Idiot du village"],"Idiot du Village"),n(r.Cannibale,"Cannibale"),n(r.Agent,"Agent"),n(r.Espion,"Espion"),n(r.Scientifique,"Scientifique"),n(r.Amoureux,"Amoureux"),n(r["La Bête"],"La Bête"),n(r["Chasseur de primes"],"Chasseur de primes"),n(r.Vaudou,"Vaudou")});const v=[];f.forEach(r=>{const i=r.Game?.toString(),n=r.Date,o=r["Liste des joueurs"],p=r["Camp victorieux"],w=r["Liste des gagnants"];if(i&&o&&n&&w){const S=j(o.toString());if(S.some(T=>T.toLowerCase()===d.toLowerCase())){const T=b(x,i,d),z=y(d,w?.toString()),V=m(n);v.push({gameId:i,date:V,camp:T,won:z,winnerCamp:p?.toString()||"",playersInGame:S.length})}}}),v.sort((r,i)=>{const n=o=>{const p=o.split("/");return p.length===3?new Date(parseInt(p[2]),parseInt(p[1])-1,parseInt(p[0])):new Date(o)};return n(i.date).getTime()-n(r.date).getTime()});const c=v.length,a=v.filter(r=>r.won).length,s=c>0?(a/c*100).toFixed(2):"0.00",t={};return v.forEach(r=>{t[r.camp]||(t[r.camp]={appearances:0,wins:0,winRate:"0.00"}),t[r.camp].appearances++,r.won&&t[r.camp].wins++}),Object.keys(t).forEach(r=>{const i=t[r];i.winRate=i.appearances>0?(i.wins/i.appearances*100).toFixed(2):"0.00"}),{playerName:d,totalGames:c,totalWins:a,winRate:s,games:v,campStats:t}},[d,f,u]),isLoading:h||l,error:P||A}}function re(){const[d,f]=g.useState("Ponce"),[h,P]=g.useState("session"),{data:u}=W(),{data:l,isLoading:A,error:G}=Y(d);console.log("DEBUG playerGameHistory:",l);const j=g.useMemo(()=>u?.playerStats?u.playerStats.filter(a=>a.gamesPlayed>0).map(a=>a.player).sort():["Ponce"],[u]),y=g.useMemo(()=>{if(!l?.games)return new Map;const a=new Map;return l.games.forEach(s=>{if(!a.has(s.date)){const t=s.date.split("/");t.length===3?a.set(s.date,new Date(parseInt(t[2]),parseInt(t[1])-1,parseInt(t[0])).getTime()):a.set(s.date,new Date(s.date).getTime())}}),a},[l?.games]),b=g.useMemo(()=>{if(!l?.games)return[];const a={};return l.games.forEach(s=>{let t;if(h==="month"){const r=s.date.split("/");r.length===3?t=`${r[1]}/${r[2]}`:t=s.date}else t=s.date;a[t]||(a[t]={games:[],wins:0,total:0}),a[t].games.push(s),a[t].total++,s.won&&a[t].wins++}),Object.entries(a).map(([s,t])=>({period:s,totalGames:t.total,victories:t.wins,defeats:t.total-t.wins,winRate:t.total>0?(t.wins/t.total*100).toFixed(1):"0.0",winRateNum:t.total>0?t.wins/t.total*100:0})).sort((s,t)=>{if(h==="month"){const[r,i]=s.period.split("/"),[n,o]=t.period.split("/"),p=new Date(parseInt(i),parseInt(r)-1,1),w=new Date(parseInt(o),parseInt(n)-1,1);return p.getTime()-w.getTime()}else{const r=y.get(s.period)||0,i=y.get(t.period)||0;return r-i}})},[l,h,y]),m=g.useMemo(()=>l?.campStats?Object.entries(l.campStats).map(([a,s])=>({name:a,value:s.appearances,winRate:s.winRate,wins:s.wins,percentage:(s.appearances/l.totalGames*100).toFixed(1)})):[],[l]),x=g.useMemo(()=>{if(!m.length)return[];const a=5;let s=0;const t=[],r=[];if(m.forEach(i=>{parseFloat(i.percentage)<a?(s+=Number(i.value),t.push(i)):r.push(i)}),s>0){const i=m.reduce((n,o)=>n+Number(o.value),0);r.push({name:"Autres",value:s,winRate:"0.0",wins:t.reduce((n,o)=>n+o.wins,0),percentage:(s/i*100).toFixed(1),_details:t})}return r},[m]),c=(a=>a<=15?{fontSize:11,angle:-45,height:80,interval:0}:a<=30?{fontSize:10,angle:-45,height:85,interval:1}:a<=50?{fontSize:9,angle:-60,height:95,interval:2}:{fontSize:8,angle:-75,height:105,interval:Math.floor(a/12)})(b.length);return A?e.jsx("div",{className:"donnees-attente",children:"Chargement de l'historique du joueur..."}):G?e.jsxs("div",{className:"donnees-probleme",children:["Erreur: ",G]}):l?e.jsxs("div",{className:"lycans-player-history",children:[e.jsx("h2",{children:"Historique Détaillé d'un Joueur"}),e.jsxs("div",{className:"lycans-controls-section",style:{display:"flex",gap:"2rem",marginBottom:"2rem",justifyContent:"center",flexWrap:"wrap"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("label",{htmlFor:"player-select",style:{color:"var(--text-secondary)",fontSize:"0.9rem"},children:"Joueur:"}),e.jsx("select",{id:"player-select",value:d,onChange:a=>f(a.target.value),style:{background:"var(--bg-tertiary)",color:"var(--text-primary)",border:"1px solid var(--border-color)",borderRadius:"4px",padding:"0.5rem",fontSize:"0.9rem",minWidth:"120px"},children:j.map(a=>e.jsx("option",{value:a,children:a},a))})]}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("label",{htmlFor:"grouping-select",style:{color:"var(--text-secondary)",fontSize:"0.9rem"},children:"Groupement:"}),e.jsxs("select",{id:"grouping-select",value:h,onChange:a=>P(a.target.value),style:{background:"var(--bg-tertiary)",color:"var(--text-primary)",border:"1px solid var(--border-color)",borderRadius:"4px",padding:"0.5rem",fontSize:"0.9rem",minWidth:"120px"},children:[e.jsx("option",{value:"session",children:"Par session"}),e.jsx("option",{value:"month",children:"Par mois"})]})]})]}),e.jsxs("div",{className:"lycans-resume-conteneur",children:[e.jsxs("div",{className:"lycans-stat-carte",children:[e.jsx("h3",{children:"Total Parties"}),e.jsx("div",{className:"lycans-valeur-principale",children:l.totalGames}),e.jsx("p",{children:"parties jouées"})]}),e.jsxs("div",{className:"lycans-stat-carte",children:[e.jsx("h3",{children:"Victoires"}),e.jsx("div",{className:"lycans-valeur-principale",children:l.totalWins}),e.jsx("p",{children:"parties gagnées"})]}),e.jsxs("div",{className:"lycans-stat-carte",children:[e.jsx("h3",{children:"Taux de Victoire"}),e.jsxs("div",{className:"lycans-valeur-principale",children:[l.winRate,"%"]}),e.jsx("p",{children:"pourcentage global"})]})]}),e.jsxs("div",{className:"lycans-graphiques-groupe",children:[e.jsxs("div",{className:"lycans-graphique-section",children:[e.jsxs("h3",{children:["Évolution des Performances ",h==="month"?"par Mois":"par Session"]}),e.jsx(k,{title:`Évolution des Performances ${h==="month"?"par Mois":"par Session"}`,children:e.jsx("div",{style:{height:400},children:e.jsx(C,{width:"100%",height:"100%",children:e.jsxs(H,{data:b,margin:{top:20,right:30,left:20,bottom:60},children:[e.jsx(I,{strokeDasharray:"3 3"}),e.jsx(L,{dataKey:"period",angle:c.angle,textAnchor:"end",height:c.height,interval:c.interval,fontSize:c.fontSize}),e.jsx(N,{label:{value:"Taux de victoire (%)",angle:-90,position:"insideLeft"},domain:[0,100]}),e.jsx(D,{content:({active:a,payload:s})=>{if(a&&s&&s.length>0){const t=s[0].payload;return e.jsxs("div",{style:{background:"var(--bg-secondary)",color:"var(--text-primary)",padding:12,borderRadius:8,border:"1px solid var(--border-color)"},children:[e.jsx("div",{children:e.jsx("strong",{children:t.period})}),e.jsxs("div",{children:["Parties: ",t.totalGames]}),e.jsxs("div",{children:["Victoires: ",t.victories]}),e.jsxs("div",{children:["Taux: ",t.winRate,"%"]})]})}return null}}),e.jsx(O,{type:"monotone",dataKey:"winRateNum",stroke:"var(--accent-primary)",strokeWidth:2,dot:{fill:"var(--accent-primary)",strokeWidth:2,r:4}})]})})})})]}),e.jsxs("div",{className:"lycans-graphique-section",children:[e.jsxs("h3",{children:["Répartition Victoires/Défaites ",h==="month"?"par Mois":"par Session"]}),e.jsx(k,{title:`Répartition Victoires/Défaites ${h==="month"?"par Mois":"par Session"}`,children:e.jsx("div",{style:{height:400},children:e.jsx(C,{width:"100%",height:"100%",children:e.jsxs(E,{data:b,margin:{top:20,right:30,left:20,bottom:60},children:[e.jsx(I,{strokeDasharray:"3 3"}),e.jsx(L,{dataKey:"period",angle:c.angle,textAnchor:"end",height:c.height,interval:c.interval,fontSize:c.fontSize}),e.jsx(N,{label:{value:"Nombre de parties",angle:-90,position:"insideLeft"},allowDecimals:!1}),e.jsx(D,{content:({active:a,payload:s})=>{if(a&&s&&s.length>0){const t=s[0].payload;return e.jsxs("div",{style:{background:"var(--bg-secondary)",color:"var(--text-primary)",padding:12,borderRadius:8,border:"1px solid var(--border-color)"},children:[e.jsx("div",{children:e.jsx("strong",{children:t.period})}),e.jsxs("div",{children:["Total: ",t.totalGames," parties"]}),e.jsxs("div",{children:["Victoires: ",t.victories]}),e.jsxs("div",{children:["Défaites: ",t.defeats]}),e.jsxs("div",{children:["Taux: ",t.winRate,"%"]})]})}return null}}),e.jsx($,{dataKey:"victories",stackId:"games",fill:"var(--accent-tertiary)",name:"Victoires"}),e.jsx($,{dataKey:"defeats",stackId:"games",fill:"var(--chart-color-4)",name:"Défaites"})]})})})})]})]}),e.jsxs("div",{className:"lycans-graphiques-groupe",children:[e.jsxs("div",{className:"lycans-graphique-section",children:[e.jsx("h3",{children:"Distribution par Camps"}),e.jsx("div",{style:{height:400},children:e.jsx(C,{width:"100%",height:"100%",children:e.jsxs(X,{children:[e.jsx(_,{data:x,cx:"50%",cy:"50%",labelLine:!1,outerRadius:120,fill:"#8884d8",dataKey:"value",label:({name:a,value:s,percent:t})=>{const r=t!==void 0?t:0;return a==="Autres"?`Autres : ${s} (${(r*100).toFixed(1)}%)`:`${a}: ${s} (${(r*100).toFixed(1)}%)`},children:x.map((a,s)=>e.jsx(F,{fill:a.name==="Autres"?K:M[a.name]||`var(--chart-color-${s%6+1})`},`cell-${s}`))}),e.jsx(D,{content:({active:a,payload:s})=>{if(a&&s&&s.length>0){const t=s[0].payload;if(t.name==="Autres"&&t._details){const r=[...t._details].sort((i,n)=>n.value-i.value);return e.jsxs("div",{style:{background:"var(--bg-secondary)",color:"var(--text-primary)",padding:12,borderRadius:8,border:"1px solid var(--border-color)"},children:[e.jsx("div",{children:e.jsxs("strong",{children:["Autres - ",t.value," parties (",t.percentage,"%)"]})}),e.jsx("div",{children:r.map((i,n)=>e.jsxs("div",{children:[i.name,": ",i.value," parties (",i.percentage,"%)"]},n))})]})}return e.jsxs("div",{style:{background:"var(--bg-secondary)",color:"var(--text-primary)",padding:12,borderRadius:8,border:"1px solid var(--border-color)"},children:[e.jsx("div",{children:e.jsxs("strong",{children:[t.name," (",t.percentage,"%)"]})}),e.jsxs("div",{children:["Apparitions: ",t.value]}),e.jsxs("div",{children:["Victoires: ",t.wins," (",t.winRate,"%)"]})]})}return null}})]})})})]}),e.jsxs("div",{className:"lycans-graphique-section",children:[e.jsx("h3",{children:"Performance par Camp"}),e.jsx("div",{style:{height:400},children:e.jsx(C,{width:"100%",height:"100%",children:e.jsxs(E,{data:m,margin:{top:20,right:30,left:20,bottom:80},children:[e.jsx(I,{strokeDasharray:"3 3"}),e.jsx(L,{dataKey:"name",angle:-45,textAnchor:"end",height:90,interval:0,fontSize:11}),e.jsx(N,{label:{value:"Taux de victoire (%)",angle:-90,position:"insideLeft"},domain:[0,100]}),e.jsx(D,{content:({active:a,payload:s})=>{if(a&&s&&s.length>0){const t=s[0].payload;return e.jsxs("div",{style:{background:"var(--bg-secondary)",color:"var(--text-primary)",padding:12,borderRadius:8,border:"1px solid var(--border-color)"},children:[e.jsx("div",{children:e.jsx("strong",{children:t.name})}),e.jsxs("div",{children:["Victoires: ",t.wins," / ",t.value]}),e.jsxs("div",{children:["Taux: ",t.winRate,"%"]})]})}return null}}),e.jsx($,{dataKey:"winRate",children:m.map((a,s)=>e.jsx(F,{fill:M[a.name]||`var(--chart-color-${s%6+1})`},`cell-${s}`))})]})})})]})]})]}):e.jsx("div",{className:"donnees-manquantes",children:"Aucune donnée d'historique disponible"})}export{re as PlayerGameHistoryChart};
