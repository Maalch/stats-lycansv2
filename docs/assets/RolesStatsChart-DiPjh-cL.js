import{u as q,r as I,j as a}from"./index-CJj5Tz_g.js";import{u as z}from"./baseStatsHook-eyTq00dn.js";import{F as D,C as $,X as N,Y as G}from"./FullscreenChart-EUGD-waH.js";import{a as X,g as _}from"./datasyncExport-BirWLS1z.js";import{b as K}from"./api-DE4zxPhP.js";import{i as O,g as Y,V as Z}from"./roleUtils-g252S1-m.js";import{R as H,T as J,a as Q}from"./CategoricalChart-DZayLyH8.js";import{B as U,a as ee}from"./BarChart-D4DgAwhU.js";function oe(C){if(C.length===0)return null;const g=new Map,m=new Map,c=new Map,r=new Map;C.forEach(d=>{if(!d.Modded)return;const l=[];let e=!1,p=!1;if(d.PlayerStats.forEach(i=>{if(i.MainRoleInitial==="Inconnu")return;const s=i.Victorious,h=X(i.MainRoleInitial,i.MainRoleChanges||[])!==i.MainRoleInitial,u=_(i.MainRoleInitial),n=u==="Loup"||u==="Tra√Ætre"||u==="Louveteau";if(u==="Villageois"&&i.Victorious&&(e=!0),u==="Villageois"&&O(i)){const o=Y(i);if(o&&Z.includes(o)){l.push(o),h&&(p=!0);const t=g.get(o)||{appearances:0,wins:0,winsWithoutRoleChange:0,gamesWithoutRoleChange:0};g.set(o,{appearances:t.appearances+1,wins:t.wins+(s?1:0),winsWithoutRoleChange:t.winsWithoutRoleChange+(!h&&s?1:0),gamesWithoutRoleChange:t.gamesWithoutRoleChange+(h?0:1)})}}else if(i.Power&&i.Power.trim()!==""&&i.Power!=="Inconnu"){if(u==="Villageois"){const o=g.get(i.Power)||{appearances:0,wins:0,winsWithoutRoleChange:0,gamesWithoutRoleChange:0};g.set(i.Power,{appearances:o.appearances+1,wins:o.wins+(s?1:0),winsWithoutRoleChange:o.winsWithoutRoleChange+(!h&&s?1:0),gamesWithoutRoleChange:o.gamesWithoutRoleChange+(h?0:1)})}else if(n){const o=m.get(i.Power)||{appearances:0,wins:0,winsWithoutRoleChange:0,gamesWithoutRoleChange:0,roleBreakdown:new Map},t=o.roleBreakdown;t.set(i.MainRoleInitial,(t.get(i.MainRoleInitial)||0)+1),m.set(i.Power,{appearances:o.appearances+1,wins:o.wins+(s?1:0),winsWithoutRoleChange:o.winsWithoutRoleChange+(!h&&s?1:0),gamesWithoutRoleChange:o.gamesWithoutRoleChange+(h?0:1),roleBreakdown:t})}}else if((u==="Villageois"||n)&&i.Power!=="Inconnu")if(u==="Villageois"){const o=g.get("Aucun pouvoir")||{appearances:0,wins:0,winsWithoutRoleChange:0,gamesWithoutRoleChange:0};g.set("Aucun pouvoir",{appearances:o.appearances+1,wins:o.wins+(s?1:0),winsWithoutRoleChange:o.winsWithoutRoleChange+(!h&&s?1:0),gamesWithoutRoleChange:o.gamesWithoutRoleChange+(h?0:1)})}else{const o=m.get("Aucun pouvoir")||{appearances:0,wins:0,winsWithoutRoleChange:0,gamesWithoutRoleChange:0,roleBreakdown:new Map},t=o.roleBreakdown;t.set(i.MainRoleInitial,(t.get(i.MainRoleInitial)||0)+1),m.set("Aucun pouvoir",{appearances:o.appearances+1,wins:o.wins+(s?1:0),winsWithoutRoleChange:o.winsWithoutRoleChange+(!h&&s?1:0),gamesWithoutRoleChange:o.gamesWithoutRoleChange+(h?0:1),roleBreakdown:t})}if(i.SecondaryRole&&i.SecondaryRole.trim()!==""&&i.SecondaryRole!=="Inconnu"){const o=c.get(i.SecondaryRole)||{appearances:0,wins:0,winsWithoutRoleChange:0,gamesWithoutRoleChange:0};c.set(i.SecondaryRole,{appearances:o.appearances+1,wins:o.wins+(s?1:0),winsWithoutRoleChange:o.winsWithoutRoleChange+(!h&&s?1:0),gamesWithoutRoleChange:o.gamesWithoutRoleChange+(h?0:1)})}}),l.length>0){const s=[...l].sort().join(" + "),w=r.get(s)||{appearances:0,wins:0,winsWithoutRoleChange:0,gamesWithoutRoleChange:0};r.set(s,{appearances:w.appearances+1,wins:w.wins+(e?1:0),winsWithoutRoleChange:w.winsWithoutRoleChange+(!p&&e?1:0),gamesWithoutRoleChange:w.gamesWithoutRoleChange+(p?0:1)})}});const y=d=>Array.from(d.entries()).map(([l,e])=>({name:l,appearances:e.appearances,wins:e.wins,winsWithoutRoleChange:e.winsWithoutRoleChange,gamesWithoutRoleChange:e.gamesWithoutRoleChange,winRate:e.gamesWithoutRoleChange>0?(e.winsWithoutRoleChange/e.gamesWithoutRoleChange*100).toFixed(1):"0.0",winRateDisplay:Math.max(e.gamesWithoutRoleChange>0?e.winsWithoutRoleChange/e.gamesWithoutRoleChange*100:0,1)})).sort((l,e)=>e.appearances-l.appearances),R=d=>Array.from(d.entries()).map(([l,e])=>({name:l,appearances:e.appearances,wins:e.wins,winsWithoutRoleChange:e.winsWithoutRoleChange,gamesWithoutRoleChange:e.gamesWithoutRoleChange,winRate:e.gamesWithoutRoleChange>0?(e.winsWithoutRoleChange/e.gamesWithoutRoleChange*100).toFixed(1):"0.0",winRateDisplay:Math.max(e.gamesWithoutRoleChange>0?e.winsWithoutRoleChange/e.gamesWithoutRoleChange*100:0,1),roleBreakdown:Array.from(e.roleBreakdown.entries()).map(([p,i])=>({role:p,count:i})).sort((p,i)=>i.count-p.count)})).sort((l,e)=>e.appearances-l.appearances),b=d=>Array.from(d.entries()).map(([l,e])=>({name:l,appearances:e.appearances,wins:e.wins,winsWithoutRoleChange:e.winsWithoutRoleChange,gamesWithoutRoleChange:e.gamesWithoutRoleChange,winRate:e.gamesWithoutRoleChange>0?(e.winsWithoutRoleChange/e.gamesWithoutRoleChange*100).toFixed(1):"0.0",winRateDisplay:Math.max(e.gamesWithoutRoleChange>0?e.winsWithoutRoleChange/e.gamesWithoutRoleChange*100:0,1)})).sort((l,e)=>e.appearances-l.appearances);return{villageoisPowers:y(g),loupPowers:R(m),secondaryRoles:b(c),villageoisEliteCombinations:y(r)}}function ue(){const{navigateToGameDetails:C,navigationState:g,updateNavigationState:m}=q(),c=K(),[r,y]=I.useState(g.rolesStatsState?.chartMode||"appearances"),{data:R,isLoading:b,error:d}=z(n=>oe(n));I.useEffect(()=>{(!g.rolesStatsState||g.rolesStatsState.chartMode!==r)&&m({rolesStatsState:{chartMode:r}})},[r,g.rolesStatsState,m]);const l=n=>{y(n),m({rolesStatsState:{chartMode:n}})},e=I.useMemo(()=>{if(!R)return{villageoisPowers:[],loupPowers:[],secondaryRoles:[],villageoisEliteCombinations:[]};const n=r==="winRate"?(o,t)=>parseFloat(t.winRate)-parseFloat(o.winRate):(o,t)=>t.appearances-o.appearances;return{villageoisPowers:[...R.villageoisPowers].sort(n),loupPowers:[...R.loupPowers].sort(n),secondaryRoles:[...R.secondaryRoles].sort(n),villageoisEliteCombinations:[...R.villageoisEliteCombinations].sort(n)}},[R,r]);if(b)return a.jsx("div",{className:"donnees-attente",children:"Chargement des statistiques des r√¥les..."});if(d)return a.jsxs("div",{className:"donnees-probleme",children:["Erreur: ",d]});if(!R)return a.jsx("div",{className:"donnees-manquantes",children:"Aucune donn√©e de r√¥le disponible"});const p=e.villageoisPowers.length>0,i=e.loupPowers.length>0,s=e.secondaryRoles.length>0,w=e.villageoisEliteCombinations.length>0;if(!p&&!i&&!s&&!w)return a.jsx("div",{className:"donnees-manquantes",children:"Aucun pouvoir ou r√¥le secondaire trouv√©"});const h=({active:n,payload:o})=>{if(n&&o&&o.length>0){const t=o[0].payload,M=t.gamesWithoutRoleChange<t.appearances;return a.jsxs("div",{style:{background:"var(--bg-secondary)",color:"var(--text-primary)",padding:12,borderRadius:8,border:"1px solid var(--border-color)"},children:[a.jsx("div",{children:a.jsx("strong",{children:t.name})}),a.jsxs("div",{children:["Apparitions: ",t.appearances]}),M&&a.jsxs("div",{style:{fontSize:"0.85rem",color:"var(--text-secondary)",fontStyle:"italic",marginTop:"0.25rem"},children:["dont ",t.appearances-t.gamesWithoutRoleChange," avec changement de r√¥le (exclu du calcul)"]}),a.jsxs("div",{children:["Victoires: ",t.winsWithoutRoleChange]}),a.jsx("div",{children:a.jsxs("strong",{children:["Taux de victoire: ",t.winRate,"%"]})}),t.roleBreakdown&&t.roleBreakdown.length>0&&a.jsxs("div",{style:{fontSize:"0.9rem",color:"var(--text-secondary)",marginTop:"0.25rem"},children:[a.jsx("div",{style:{fontStyle:"italic"},children:"R√©partition par r√¥le:"}),t.roleBreakdown.map((W,S)=>a.jsxs("div",{style:{marginLeft:"0.5rem"},children:["‚Ä¢ ",W.role,": ",W.count]},S))]}),a.jsx("div",{style:{fontSize:"0.8rem",color:"var(--accent-primary)",marginTop:"0.5rem",fontWeight:"bold",textAlign:"center",animation:"pulse 1.5s infinite"},children:"üñ±Ô∏è Cliquez pour voir les parties"})]})}return null},u=(n,o,t,M,W)=>{const S=r==="appearances"?"appearances":"winRateDisplay",V=r==="appearances"?"Nombre d'apparitions":"Taux de victoire (%)",F=r==="winRate"?[0,100]:void 0;return a.jsxs("div",{className:"lycans-graphique-section",children:[a.jsx("h3",{children:o}),a.jsx(D,{title:A=>A?`${o} (Tous)`:`${o} (Top 15)`,children:A=>{const k=A?n:n.slice(0,15);return a.jsx("div",{style:{height:400},children:a.jsx(H,{width:"100%",height:"100%",children:a.jsxs(U,{data:k,margin:{top:20,right:30,left:20,bottom:80},children:[a.jsx($,{strokeDasharray:"3 3"}),a.jsx(N,{dataKey:"name",angle:-45,textAnchor:"end",height:90,interval:0,fontSize:12,tick:({x,y:v,payload:f})=>a.jsx("text",{x,y:v,dy:16,textAnchor:"end",fill:"var(--text-secondary)",fontSize:12,transform:`rotate(-45 ${x} ${v})`,children:f.value})}),a.jsx(G,{label:{value:V,angle:270,position:"left",style:{textAnchor:"middle"}},domain:F}),a.jsx(J,{content:a.jsx(h,{})}),a.jsx(ee,{dataKey:S,label:r==="winRate"?x=>{const{x:v,y:f,width:j,payload:P}=x;if(v===void 0||f===void 0||j===void 0||!P)return null;const E=P.winRate||"0";return a.jsxs("text",{x:v+j/2,y:f-5,fill:"var(--text-primary)",textAnchor:"middle",fontSize:"12",fontWeight:"bold",children:[E,"%"]})}:void 0,shape:x=>{const{x:v,y:f,width:j,height:P,payload:E,index:B}=x,T=E,L=W?W(T.name,B??0):t;return a.jsx(Q,{x:v,y:f,width:j,height:P,fill:L,onClick:()=>M(T.name),style:{cursor:"pointer"}})}})]})})})}})]})};return a.jsxs("div",{className:"lycans-camps-container",children:[a.jsx("h2",{children:"Statistiques G√©n√©rales des R√¥les et Pouvoirs"}),a.jsxs("div",{style:{marginBottom:"1.5rem",display:"flex",alignItems:"center",gap:"0.5rem"},children:[a.jsx("label",{htmlFor:"chart-mode-select",style:{color:"var(--text-secondary)",fontSize:"0.9rem",fontWeight:"bold"},children:"Affichage :"}),a.jsxs("select",{id:"chart-mode-select",value:r,onChange:n=>l(n.target.value),style:{background:"var(--bg-tertiary)",color:"var(--text-primary)",border:"1px solid var(--border-color)",borderRadius:"4px",padding:"0.5rem",fontSize:"0.9rem",minWidth:"180px"},children:[a.jsx("option",{value:"appearances",children:"Apparitions"}),a.jsx("option",{value:"winRate",children:"Taux de victoire"})]})]}),a.jsxs("div",{className:"lycans-graphiques-groupe",children:[p&&u(e.villageoisPowers,"Camp Villageois","var(--chart-color-1)",n=>{C({campFilter:{selectedCamp:"Villageois",campFilterMode:r==="winRate"?"wins-only":"all-assignments"},selectedPower:n,fromComponent:`Statistiques des R√¥les - Pouvoir: ${n}`})},n=>n==="Chasseur"&&c.Chasseur?c.Chasseur:n==="Alchimiste"&&c.Alchimiste?c.Alchimiste:n==="Protecteur"&&c.Protecteur?c.Protecteur:n==="Disciple"&&c.Disciple?c.Disciple:n==="Inquisiteur"&&c.Inquisiteur?c.Inquisiteur:"var(--chart-color-1)"),w&&u(e.villageoisEliteCombinations,"Combinaisons de Villageois √âlite","var(--chart-color-4)",n=>{C({campFilter:{selectedCamp:"Villageois",campFilterMode:r==="winRate"?"wins-only":"all-assignments"},fromComponent:`Statistiques des R√¥les - Combinaison: ${n}`})},()=>"var(--chart-color-4)"),i&&u(e.loupPowers,"Camp Loups","var(--chart-color-2)",n=>{C({campFilter:{selectedCamp:"Loup",campFilterMode:r==="winRate"?"wins-only":"all-assignments"},selectedPower:n,fromComponent:`Statistiques des R√¥les - Pouvoir: ${n}`})},()=>c.Loup||"var(--chart-color-2)"),s&&u(e.secondaryRoles,"R√¥les Secondaires","var(--chart-color-3)",n=>{C({selectedSecondaryRole:n,fromComponent:`Statistiques des R√¥les - R√¥le Secondaire: ${n}`})}),a.jsx("div",{style:{fontSize:"0.9rem",color:"var(--text-secondary)",fontStyle:"italic",marginTop:"16px",padding:"8px",backgroundColor:"var(--bg-tertiary)",borderRadius:"4px",border:"1px solid var(--border-color)"},children:"‚ÑπÔ∏è Les victoires et le taux de victoire excluent les parties o√π le r√¥le principal a chang√© en cours de partie (ex: Garde en Chasseur, r√©ssucit√© en Zombie par un Vaudou, etc...)."})]})]})}export{ue as RolesStatsChart};
