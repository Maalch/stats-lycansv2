import{r as v,u as V,j as r}from"./index-CSjSU2-u.js";import{u as B,a as K}from"./useRawGameData-CvorIhgh.js";import{u as W}from"./usePlayerStatsFromRaw-CbixfS4N.js";import{l as H,a as M}from"./api-beq3FXpM.js";import{F as N,R as S,C as R,X as k,Y as z,T as w,B as q,o as I,p as D}from"./FullscreenChart-Bvx1ef1p.js";import{L as J,a as O}from"./LineChart-DWJ8AkzY.js";import{P as X,a as _}from"./PieChart-D6Wbz1Aw.js";function Y(l){const{data:f,isLoading:d,error:P}=B(),{data:x,isLoading:o,error:A}=K();return{data:v.useMemo(()=>{if(!l||l.trim()===""||!f||f.length===0||!x||x.length===0)return null;const u=e=>e?e.split(",").map(a=>a.trim()).filter(Boolean):[],$=(e,a)=>a&&a.trim()!==""?u(a).some(n=>n.toLowerCase()===e.toLowerCase()):!1,y=(e,a,i)=>e[a]&&e[a][i]||"Villageois",g=e=>{if(e instanceof Date){const a=e.getDate().toString().padStart(2,"0"),i=(e.getMonth()+1).toString().padStart(2,"0"),n=e.getFullYear();return`${a}/${i}/${n}`}if(typeof e=="string"){if(/^\d{2}\/\d{2}\/\d{4}$/.test(e))return e;if(/^\d{4}-\d{2}-\d{2}$/.test(e)){const a=e.split("-");return`${a[2]}/${a[1]}/${a[0]}`}}return e?.toString()||""},p={};x.forEach(e=>{const a=e.Game?.toString();if(!a)return;p[a]||(p[a]={});const i=(n,c)=>{n&&u(n.toString()).forEach(j=>{const G=j.trim();G&&(p[a][G]=c)})};i(e.Loups,"Loups"),i(e.Traître,"Traître"),i(e["Idiot du village"],"Idiot du Village"),i(e.Cannibale,"Cannibale"),i(e.Agent,"Agent"),i(e.Espion,"Espion"),i(e.Scientifique,"Scientifique"),i(e.Amoureux,"Amoureux"),i(e["La Bête"],"La Bête"),i(e["Chasseur de primes"],"Chasseur de primes"),i(e.Vaudou,"Vaudou")});const m=[];f.forEach(e=>{const a=e.Game?.toString(),i=e.Date,n=e["Liste des joueurs"],c=e["Camp victorieux"],b=e["Liste des gagnants"];if(a&&n&&i&&b){const j=u(n.toString());if(j.some(L=>L.toLowerCase()===l.toLowerCase())){const L=y(p,a,l),E=$(l,b?.toString()),F=g(i);m.push({gameId:a,date:F,camp:L,won:E,winnerCamp:c?.toString()||"",playersInGame:j.length})}}}),m.sort((e,a)=>{const i=n=>{const c=n.split("/");return c.length===3?new Date(parseInt(c[2]),parseInt(c[1])-1,parseInt(c[0])):new Date(n)};return i(a.date).getTime()-i(e.date).getTime()});const C=m.length,h=m.filter(e=>e.won).length,s=C>0?(h/C*100).toFixed(2):"0.00",t={};return m.forEach(e=>{t[e.camp]||(t[e.camp]={appearances:0,wins:0,winRate:"0.00"}),t[e.camp].appearances++,e.won&&t[e.camp].wins++}),Object.keys(t).forEach(e=>{const a=t[e];a.winRate=a.appearances>0?(a.wins/a.appearances*100).toFixed(2):"0.00"}),{playerName:l,totalGames:C,totalWins:h,winRate:s,games:m,campStats:t}},[l,f,x]),isLoading:d||o,error:P||A}}function ae(){const[l,f]=v.useState("Ponce"),[d,P]=v.useState("session"),{data:x}=W(),{data:o,isLoading:A,error:T}=Y(l),{navigateToGameDetails:u}=V(),$=v.useMemo(()=>x?.playerStats?x.playerStats.filter(s=>s.gamesPlayed>0).map(s=>s.player).sort():["Ponce"],[x]),y=v.useMemo(()=>{if(!o?.games)return new Map;const s=new Map;return o.games.forEach(t=>{if(!s.has(t.date)){const e=t.date.split("/");e.length===3?s.set(t.date,new Date(parseInt(e[2]),parseInt(e[1])-1,parseInt(e[0])).getTime()):s.set(t.date,new Date(t.date).getTime())}}),s},[o?.games]),g=v.useMemo(()=>{if(!o?.games)return[];const s={};return o.games.forEach(t=>{let e;if(d==="month"){const a=t.date.split("/");a.length===3?e=`${a[1]}/${a[2]}`:e=t.date}else e=t.date;s[e]||(s[e]={games:[],wins:0,total:0}),s[e].games.push(t),s[e].total++,t.won&&s[e].wins++}),Object.entries(s).map(([t,e])=>({period:t,totalGames:e.total,victories:e.wins,defeats:e.total-e.wins,winRate:e.total>0?(e.wins/e.total*100).toFixed(1):"0.0",winRateNum:e.total>0?e.wins/e.total*100:0})).sort((t,e)=>{if(d==="month"){const[a,i]=t.period.split("/"),[n,c]=e.period.split("/"),b=new Date(parseInt(i),parseInt(a)-1,1),j=new Date(parseInt(c),parseInt(n)-1,1);return b.getTime()-j.getTime()}else{const a=y.get(t.period)||0,i=y.get(e.period)||0;return a-i}})},[o,d,y]),p=v.useMemo(()=>o?.campStats?Object.entries(o.campStats).map(([s,t])=>({name:s,value:t.appearances,winRate:t.winRate,wins:t.wins,percentage:(t.appearances/o.totalGames*100).toFixed(1)})):[],[o]),m=v.useMemo(()=>{if(!p.length)return[];const s=5;let t=0;const e=[],a=[];if(p.forEach(i=>{parseFloat(i.percentage)<s?(t+=Number(i.value),e.push(i)):a.push(i)}),t>0){const i=p.reduce((n,c)=>n+Number(c.value),0);a.push({name:"Autres",value:t,winRate:"0.0",wins:e.reduce((n,c)=>n+c.wins,0),percentage:(t/i*100).toFixed(1),_details:e})}return a},[p]),h=(s=>s<=15?{fontSize:11,angle:-45,height:80,interval:0}:s<=30?{fontSize:10,angle:-45,height:85,interval:1}:s<=50?{fontSize:9,angle:-60,height:95,interval:2}:{fontSize:8,angle:-75,height:105,interval:Math.floor(s/12)})(g.length);return A?r.jsx("div",{className:"donnees-attente",children:"Chargement de l'historique du joueur..."}):T?r.jsxs("div",{className:"donnees-probleme",children:["Erreur: ",T]}):o?r.jsxs("div",{className:"lycans-player-history",children:[r.jsx("h2",{children:"Historique Détaillé d'un Joueur"}),r.jsxs("div",{className:"lycans-controls-section",style:{display:"flex",gap:"2rem",marginBottom:"2rem",justifyContent:"center",flexWrap:"wrap"},children:[r.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[r.jsx("label",{htmlFor:"player-select",style:{color:"var(--text-secondary)",fontSize:"0.9rem"},children:"Joueur:"}),r.jsx("select",{id:"player-select",value:l,onChange:s=>f(s.target.value),style:{background:"var(--bg-tertiary)",color:"var(--text-primary)",border:"1px solid var(--border-color)",borderRadius:"4px",padding:"0.5rem",fontSize:"0.9rem",minWidth:"120px"},children:$.map(s=>r.jsx("option",{value:s,children:s},s))})]}),r.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[r.jsx("label",{htmlFor:"grouping-select",style:{color:"var(--text-secondary)",fontSize:"0.9rem"},children:"Groupement:"}),r.jsxs("select",{id:"grouping-select",value:d,onChange:s=>P(s.target.value),style:{background:"var(--bg-tertiary)",color:"var(--text-primary)",border:"1px solid var(--border-color)",borderRadius:"4px",padding:"0.5rem",fontSize:"0.9rem",minWidth:"120px"},children:[r.jsx("option",{value:"session",children:"Par session"}),r.jsx("option",{value:"month",children:"Par mois"})]})]})]}),r.jsxs("div",{className:"lycans-resume-conteneur",children:[r.jsxs("div",{className:"lycans-stat-carte",children:[r.jsx("h3",{children:"Total Parties"}),r.jsx("div",{className:"lycans-valeur-principale",children:o.totalGames}),r.jsx("p",{children:"parties jouées"})]}),r.jsxs("div",{className:"lycans-stat-carte",children:[r.jsx("h3",{children:"Victoires"}),r.jsx("div",{className:"lycans-valeur-principale",children:o.totalWins}),r.jsx("p",{children:"parties gagnées"})]}),r.jsxs("div",{className:"lycans-stat-carte",children:[r.jsx("h3",{children:"Taux de Victoire"}),r.jsxs("div",{className:"lycans-valeur-principale",children:[o.winRate,"%"]}),r.jsx("p",{children:"pourcentage global"})]})]}),r.jsxs("div",{className:"lycans-graphiques-groupe",children:[r.jsxs("div",{className:"lycans-graphique-section",children:[r.jsxs("h3",{children:["Évolution des Performances ",d==="month"?"par Mois":"par Session"]}),r.jsx(N,{title:`Évolution des Performances ${d==="month"?"par Mois":"par Session"}`,children:r.jsx("div",{style:{height:400},children:r.jsx(S,{width:"100%",height:"100%",children:r.jsxs(J,{data:g,margin:{top:20,right:30,left:20,bottom:60},onClick:s=>{if(s&&s.activeLabel){const t=g.find(e=>e.period===s.activeLabel);t&&u({selectedPlayer:l,selectedDate:t.period,fromComponent:`Évolution des Performances ${d==="month"?"par Mois":"par Session"}`})}},style:{cursor:"pointer"},children:[r.jsx(R,{strokeDasharray:"3 3"}),r.jsx(k,{dataKey:"period",angle:h.angle,textAnchor:"end",height:h.height,interval:h.interval,fontSize:h.fontSize}),r.jsx(z,{label:{value:"Taux de victoire (%)",angle:-90,position:"insideLeft"},domain:[0,100]}),r.jsx(w,{content:({active:s,payload:t})=>{if(s&&t&&t.length>0){const e=t[0].payload;return r.jsxs("div",{style:{background:"var(--bg-secondary)",color:"var(--text-primary)",padding:12,borderRadius:8,border:"1px solid var(--border-color)"},children:[r.jsx("div",{children:r.jsx("strong",{children:e.period})}),r.jsxs("div",{children:["Parties: ",e.totalGames]}),r.jsxs("div",{children:["Victoires: ",e.victories]}),r.jsxs("div",{children:["Taux: ",e.winRate,"%"]}),r.jsx("div",{style:{fontSize:"0.8rem",color:"var(--chart-color-1)",marginTop:"0.25rem",fontStyle:"italic"},children:"Cliquez pour voir les parties"})]})}return null}}),r.jsx(O,{type:"monotone",dataKey:"winRateNum",stroke:"var(--accent-primary)",strokeWidth:2,dot:{fill:"var(--accent-primary)",strokeWidth:2,r:4}})]})})})})]}),r.jsxs("div",{className:"lycans-graphique-section",children:[r.jsxs("h3",{children:["Répartition Victoires/Défaites ",d==="month"?"par Mois":"par Session"]}),r.jsx(N,{title:`Répartition Victoires/Défaites ${d==="month"?"par Mois":"par Session"}`,children:r.jsx("div",{style:{height:400},children:r.jsx(S,{width:"100%",height:"100%",children:r.jsxs(q,{data:g,margin:{top:20,right:30,left:20,bottom:60},children:[r.jsx(R,{strokeDasharray:"3 3"}),r.jsx(k,{dataKey:"period",angle:h.angle,textAnchor:"end",height:h.height,interval:h.interval,fontSize:h.fontSize}),r.jsx(z,{label:{value:"Nombre de parties",angle:-90,position:"insideLeft"},allowDecimals:!1}),r.jsx(w,{content:({active:s,payload:t})=>{if(s&&t&&t.length>0){const e=t[0].payload;return r.jsxs("div",{style:{background:"var(--bg-secondary)",color:"var(--text-primary)",padding:12,borderRadius:8,border:"1px solid var(--border-color)"},children:[r.jsx("div",{children:r.jsx("strong",{children:e.period})}),r.jsxs("div",{children:["Total: ",e.totalGames," parties"]}),r.jsxs("div",{children:["Victoires: ",e.victories]}),r.jsxs("div",{children:["Défaites: ",e.defeats]}),r.jsxs("div",{children:["Taux: ",e.winRate,"%"]}),r.jsx("div",{style:{fontSize:"0.8rem",color:"var(--chart-color-1)",marginTop:"0.25rem",fontStyle:"italic"},children:"Cliquez pour voir les parties"})]})}return null}}),r.jsx(I,{dataKey:"victories",stackId:"games",fill:"var(--accent-tertiary)",name:"Victoires",children:g.map((s,t)=>r.jsx(D,{fill:"var(--accent-tertiary)",onClick:()=>{u({selectedPlayer:l,selectedDate:s.period,fromComponent:`Historique Joueur - Victoires ${d==="month"?"par Mois":"par Session"}`})},style:{cursor:"pointer"}},`cell-victories-${t}`))}),r.jsx(I,{dataKey:"defeats",stackId:"games",fill:"var(--chart-color-4)",name:"Défaites",children:g.map((s,t)=>r.jsx(D,{fill:"var(--chart-color-4)",onClick:()=>{u({selectedPlayer:l,selectedDate:s.period,fromComponent:`Historique Joueur - Défaites ${d==="month"?"par Mois":"par Session"}`})},style:{cursor:"pointer"}},`cell-defeats-${t}`))})]})})})})]})]}),r.jsxs("div",{className:"lycans-graphiques-groupe",children:[r.jsxs("div",{className:"lycans-graphique-section",children:[r.jsx("h3",{children:"Distribution par Camps"}),r.jsx("div",{style:{height:400},children:r.jsx(S,{width:"100%",height:"100%",children:r.jsxs(X,{children:[r.jsx(_,{data:m,cx:"50%",cy:"50%",labelLine:!1,outerRadius:120,fill:"#8884d8",dataKey:"value",label:({name:s,value:t,percent:e})=>{const a=e!==void 0?e:0;return s==="Autres"?`Autres : ${t} (${(a*100).toFixed(1)}%)`:`${s}: ${t} (${(a*100).toFixed(1)}%)`},children:m.map((s,t)=>r.jsx(D,{fill:s.name==="Autres"?H:M[s.name]||`var(--chart-color-${t%6+1})`,onClick:()=>{s.name!=="Autres"&&u({selectedPlayer:l,selectedCamp:s.name,fromComponent:"Distribution par Camps"})},style:{cursor:s.name!=="Autres"?"pointer":"default"}},`cell-${t}`))}),r.jsx(w,{content:({active:s,payload:t})=>{if(s&&t&&t.length>0){const e=t[0].payload;if(e.name==="Autres"&&e._details){const a=[...e._details].sort((i,n)=>n.value-i.value);return r.jsxs("div",{style:{background:"var(--bg-secondary)",color:"var(--text-primary)",padding:12,borderRadius:8,border:"1px solid var(--border-color)"},children:[r.jsx("div",{children:r.jsxs("strong",{children:["Autres - ",e.value," parties (",e.percentage,"%)"]})}),r.jsx("div",{children:a.map((i,n)=>r.jsxs("div",{children:[i.name,": ",i.value," parties (",i.percentage,"%)"]},n))})]})}return r.jsxs("div",{style:{background:"var(--bg-secondary)",color:"var(--text-primary)",padding:12,borderRadius:8,border:"1px solid var(--border-color)"},children:[r.jsx("div",{children:r.jsxs("strong",{children:[e.name," (",e.percentage,"%)"]})}),r.jsxs("div",{children:["Apparitions: ",e.value]}),r.jsxs("div",{children:["Victoires: ",e.wins," (",e.winRate,"%)"]}),e.name!=="Autres"&&r.jsx("div",{style:{fontSize:"0.8rem",color:"var(--chart-color-1)",marginTop:"0.25rem",fontStyle:"italic"},children:"Cliquez pour voir les parties"})]})}return null}})]})})})]}),r.jsxs("div",{className:"lycans-graphique-section",children:[r.jsx("h3",{children:"Performance par Camp"}),r.jsx(N,{title:"Performance par Camp",children:r.jsx("div",{style:{height:400},children:r.jsx(S,{width:"100%",height:"100%",children:r.jsxs(q,{data:p,margin:{top:20,right:30,left:20,bottom:80},children:[r.jsx(R,{strokeDasharray:"3 3"}),r.jsx(k,{dataKey:"name",angle:-45,textAnchor:"end",height:90,interval:0,fontSize:11}),r.jsx(z,{label:{value:"Taux de victoire (%)",angle:-90,position:"insideLeft"},domain:[0,100]}),r.jsx(w,{content:({active:s,payload:t})=>{if(s&&t&&t.length>0){const e=t[0].payload;return r.jsxs("div",{style:{background:"var(--bg-secondary)",color:"var(--text-primary)",padding:12,borderRadius:8,border:"1px solid var(--border-color)"},children:[r.jsx("div",{children:r.jsx("strong",{children:e.name})}),r.jsxs("div",{children:["Victoires: ",e.wins," / ",e.value]}),r.jsxs("div",{children:["Taux: ",e.winRate,"%"]}),r.jsx("div",{style:{fontSize:"0.8rem",color:"var(--chart-color-1)",marginTop:"0.25rem",fontStyle:"italic"},children:"Cliquez pour voir les parties"})]})}return null}}),r.jsx(I,{dataKey:"winRate",children:p.map((s,t)=>r.jsx(D,{fill:M[s.name]||`var(--chart-color-${t%6+1})`,onClick:()=>{u({selectedPlayer:l,selectedCamp:s.name,fromComponent:"Performance par Camp"})},style:{cursor:"pointer"}},`cell-${t}`))})]})})})})]})]})]}):r.jsx("div",{className:"donnees-manquantes",children:"Aucune donnée d'historique disponible"})}export{ae as PlayerGameHistoryChart};
