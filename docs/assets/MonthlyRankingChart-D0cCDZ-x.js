import{r,j as e,u as ue,a as ge,d as fe,g as pe}from"./index-BxRRYSf2.js";import{u as ye}from"./useJoueursData-CFJq1noO.js";import{u as xe,C as Pe}from"./api-DB1XyeYA.js";import{F as je}from"./FullscreenChart-DlQkj81i.js";import{b as be}from"./datasyncExport-BirWLS1z.js";const ve=38,Ne=34,we="#8884d8";function Me(t){return t===0?"bar-race-rank--top1":t===1?"bar-race-rank--top2":t===2?"bar-race-rank--top3":""}function Ce(t){return t===0?"ðŸ¥‡":t===1?"ðŸ¥ˆ":t===2?"ðŸ¥‰":`${t+1}`}function ke(t,l){return l?t.isNew?{text:"ðŸ†•",className:"bar-race-delta--new"}:t.rankDelta===null||t.rankDelta===0?{text:"â€”",className:"bar-race-delta--same"}:t.rankDelta>0?{text:`â–²${t.rankDelta}`,className:"bar-race-delta--up"}:{text:`â–¼${Math.abs(t.rankDelta)}`,className:"bar-race-delta--down"}:{text:"",className:"bar-race-delta--same"}}function Re({players:t,playersColor:l,highlightedPlayer:u,transitionDuration:o,onPlayerClick:p,isFullscreen:j,isAnimating:b}){const c=j?Ne:ve,v=r.useMemo(()=>{if(t.length===0)return 100;const a=Math.max(...t.map(x=>x.winPercent));return Math.max(50,Math.min(100,Math.ceil(a/10)*10))},[t]),g=t.length*c,N=`${o}ms`;return t.length===0?e.jsx("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",height:j?400:300,color:"var(--text-secondary)",fontSize:"1rem"},children:"Aucun joueur Ã©ligible pour le moment"}):e.jsx("div",{className:"bar-race-container",style:{height:g,transitionDuration:N},children:t.map(a=>{const x=u===a.name,w=a.isHighlightedAddition,F=l[a.name]||we,M=v>0?a.winPercent/v*100:0,R=a.rank*c,G=ke(a,b),h=["bar-race-row",j?"bar-race-row--fullscreen":"",a.isNew&&b?"bar-race-row--entering":""].filter(Boolean).join(" "),_=["bar-race-bar",x?"bar-race-bar--highlighted":"",w?"bar-race-bar--addition":""].filter(Boolean).join(" ");return e.jsxs("div",{className:h,style:{transform:`translateY(${R}px)`,transitionDuration:N,"--bar-race-target-y":`${R}px`,"--bar-race-enter-y":`${R+c}px`},onClick:()=>p(a.name),children:[e.jsx("span",{className:`bar-race-rank ${Me(a.rank)}`,children:Ce(a.rank)}),e.jsx("span",{className:`bar-race-label ${x?"bar-race-label--highlighted":""}`,children:a.name}),e.jsx("span",{className:`bar-race-delta ${G.className}`,children:G.text}),e.jsx("div",{className:"bar-race-track",children:e.jsx("div",{className:_,style:{width:`${M}%`,backgroundColor:F,transitionDuration:N}})}),e.jsxs("span",{className:"bar-race-value",children:[a.winPercent.toFixed(1),"%"]}),e.jsxs("span",{className:"bar-race-games",children:[a.wins,"/",a.gamesPlayed]})]},a.name)})})}function Se(t){const l=t.PlayerStats.find(o=>o.Victorious);if(!l)return{camp:"Inconnu",className:"",emoji:"â“"};switch(be(l.MainRoleInitial,l.Power)){case"Loup":return{camp:"Loups",className:"game-context-winner--loups",emoji:"ðŸº"};case"Villageois":return{camp:"Villageois",className:"game-context-winner--villageois",emoji:"ðŸ˜ï¸"};default:return{camp:l.MainRoleInitial,className:"game-context-winner--solo",emoji:"ðŸŽ­"}}}function De(t){return new Date(t).toLocaleDateString("fr-FR",{day:"numeric",month:"short"})}function Ae({game:t,onGameClick:l}){const{camp:u,className:o,emoji:p}=Se(t),j=t.PlayerStats.length,b=t.PlayerStats.filter(c=>c.Victorious).map(c=>c.Username);return e.jsxs("div",{className:"game-context-panel",children:[e.jsxs("span",{className:"game-context-id",onClick:()=>l(t.DisplayedId),title:"Voir les dÃ©tails de la partie",children:["#",t.DisplayedId]}),e.jsx("span",{className:"game-context-separator",children:"|"}),e.jsxs("span",{className:"game-context-map",children:["ðŸ“ ",t.MapName]}),e.jsx("span",{className:"game-context-separator",children:"|"}),e.jsxs("span",{className:`game-context-winner ${o}`,children:[p," ",u]}),e.jsx("span",{className:"game-context-separator",children:"|"}),e.jsxs("span",{style:{color:"var(--text-secondary)",fontSize:"0.8rem"},children:[De(t.StartDate)," Â· ",j,"j",t.EndTiming?` Â· ${t.EndTiming}`:""]}),e.jsx("span",{className:"game-context-separator",children:"|"}),e.jsxs("span",{className:"game-context-players",children:["Gagnants:"," ",b.length>0?b.map((c,v)=>e.jsxs("span",{children:[v>0&&", ",e.jsx("span",{className:"game-context-player--won",children:c})]},c)):e.jsx("span",{style:{fontStyle:"italic"},children:"Aucun"})]})]})}function Te({totalGames:t,currentGameIndex:l,isPlaying:u,onSeek:o,onPause:p}){const j=l===0?t:l,b=t>0?j/t*100:0,c=v=>{u&&p();const g=Number(v.target.value);g>=t?o(0):o(Math.max(1,g))};return e.jsxs("div",{className:"monthly-timeline",children:[e.jsx("input",{type:"range",className:"monthly-timeline-slider",min:1,max:t,value:j,onChange:c,style:{background:`linear-gradient(to right, var(--accent-primary) 0%, var(--accent-primary) ${b}%, var(--bg-tertiary) ${b}%, var(--bg-tertiary) 100%)`}}),e.jsxs("div",{className:"monthly-timeline-labels",children:[e.jsx("span",{children:"Partie 1"}),e.jsx("span",{className:"monthly-timeline-current",children:l===0?`Toutes les ${t} parties`:`Partie ${l} / ${t}`}),e.jsxs("span",{children:["Partie ",t]})]})]})}const X=.4,Ge=["Janvier","FÃ©vrier","Mars","Avril","Mai","Juin","Juillet","AoÃ»t","Septembre","Octobre","Novembre","DÃ©cembre"];function Z(t){const[l,u]=t.split("-"),o=parseInt(u,10)-1;return`${Ge[o]} ${l}`}function Oe(){const{navigationState:t,updateNavigationState:l,navigateToGameDetails:u}=ue(),{settings:o}=ge(),{gameData:p}=fe(),{joueursData:j}=ye(),b=xe(j),[c,v]=r.useState(t.monthlyRankingState?.selectedMonth||null),[g,N]=r.useState(!1),[a,x]=r.useState(t.monthlyRankingState?.currentGameIndex||0),[w,F]=r.useState(t.monthlyRankingState?.playSpeed||1e3),M=r.useRef(null),R=r.useRef(new Map);r.useEffect(()=>{const n=t.monthlyRankingState;(!n||n.selectedMonth!==c||n.currentGameIndex!==a||n.playSpeed!==w)&&l({monthlyRankingState:{selectedMonth:c||void 0,currentGameIndex:a,playSpeed:w}})},[c,a,w,l]);const{months:G,monthKeys:h}=r.useMemo(()=>{if(!p||p.length===0)return{months:new Map,monthKeys:[]};const n=new Map;for(const C of p){const S=new Date(C.StartDate),y=`${S.getFullYear()}-${String(S.getMonth()+1).padStart(2,"0")}`;n.has(y)||n.set(y,[]),n.get(y).push(C)}const P=new Map;for(const[C,S]of n){const y=[...S].sort((k,W)=>new Date(k.StartDate).getTime()-new Date(W.StartDate).getTime());P.set(C,{key:C,label:Z(C),totalGames:S.length,sortedGames:y})}const I=[...P.keys()].sort();return{months:P,monthKeys:I}},[p]),D=r.useMemo(()=>c&&h.includes(c)?c:h.length>0?h[h.length-1]:null,[c,h]),i=D?G.get(D):null;r.useEffect(()=>{x(0),N(!1),R.current=new Map,M.current&&(clearInterval(M.current),M.current=null)},[D]);const{barRacePlayers:$,highlightedPlayerAdded:ee,averageWinRate:L,minGamesRequired:q,effectiveTotalGames:V,currentGame:B}=r.useMemo(()=>{if(!i)return{barRacePlayers:[],highlightedPlayerAdded:!1,averageWinRate:"0",minGamesRequired:0,effectiveTotalGames:0,currentGame:null};const n=a>0,P=n?i.sortedGames.slice(0,a):i.sortedGames,I=n?a:i.totalGames,C=Math.ceil(I*X),S=n&&P.length>0?P[P.length-1]:null,y=new Map;for(const s of P)for(const d of s.PlayerStats){const f=pe(d);y.has(f)||y.set(f,{displayName:d.Username,gamesPlayed:0,wins:0});const m=y.get(f);m.gamesPlayed++,d.Victorious&&m.wins++}const k=[];for(const[,s]of y)s.gamesPlayed>=C&&k.push({name:s.displayName,gamesPlayed:s.gamesPlayed,wins:s.wins,winPercent:s.gamesPlayed>0?s.wins/s.gamesPlayed*100:0});k.sort((s,d)=>d.winPercent-s.winPercent||d.gamesPlayed-s.gamesPlayed);const W=Pe.TOP_15,z=k.slice(0,W);let J=0;for(const s of k)J+=s.winPercent;const me=k.length>0?(J/k.length).toFixed(1):"0";let T=[...z],H=!1;if(o.highlightedPlayer&&!z.some(d=>d.name===o.highlightedPlayer)){const d=k.find(f=>f.name===o.highlightedPlayer);if(d)T.push({...d,isHighlightedAddition:!0}),H=!0;else{let f=!1;for(const[,m]of y)if(m.displayName===o.highlightedPlayer&&m.gamesPlayed>0){T.push({name:o.highlightedPlayer,gamesPlayed:m.gamesPlayed,wins:m.wins,winPercent:m.wins/m.gamesPlayed*100,isHighlightedAddition:!0}),H=!0,f=!0;break}if(!f){for(const[,m]of y)if(m.displayName===o.highlightedPlayer&&m.gamesPlayed>0){T.push({name:m.displayName,gamesPlayed:m.gamesPlayed,wins:m.wins,winPercent:m.wins/m.gamesPlayed*100,isHighlightedAddition:!0}),H=!0;break}}}}T.sort((s,d)=>s.isHighlightedAddition&&!d.isHighlightedAddition?1:!s.isHighlightedAddition&&d.isHighlightedAddition?-1:d.winPercent-s.winPercent||d.gamesPlayed-s.gamesPlayed);const U=R.current,Y=new Map,he=T.map((s,d)=>{Y.set(s.name,d);const f=U.has(s.name)?U.get(s.name):null,m=f===null&&n&&a>1;let Q=null;return f!==null&&n&&(Q=f-d),{name:s.name,winPercent:s.winPercent,gamesPlayed:s.gamesPlayed,wins:s.wins,rank:d,prevRank:f,rankDelta:Q,isNew:m,isHighlightedAddition:s.isHighlightedAddition}});return R.current=Y,{barRacePlayers:he,highlightedPlayerAdded:H,averageWinRate:me,minGamesRequired:C,effectiveTotalGames:I,currentGame:S}},[i,o.highlightedPlayer,a]),A=D?h.indexOf(D):-1,E=A>0,O=A<h.length-1,te=r.useCallback(()=>{E&&v(h[A-1])},[E,A,h]),ne=r.useCallback(()=>{O&&v(h[A+1])},[O,A,h]);r.useEffect(()=>{if(!(!g||!i))return M.current=setInterval(()=>{x(n=>{const P=n+1;return P>i.totalGames?(N(!1),0):P})},w),()=>{M.current&&(clearInterval(M.current),M.current=null)}},[g,w,i]);const ae=r.useCallback(()=>{a===0&&!g&&x(1),N(!g)},[g,a]),se=r.useCallback(()=>{N(!1),i&&x(n=>n===0?i.totalGames:Math.max(1,n-1))},[i]),ie=r.useCallback(()=>{N(!1),x(n=>i?n===0?1:n>=i.totalGames?0:n+1:n)},[i]),re=r.useCallback(n=>{x(n)},[]),le=r.useCallback(()=>{N(!1)},[]),oe=r.useCallback(n=>{u({selectedPlayer:n,selectedPlayerWinMode:"wins-only",fromComponent:`Classement Mensuel â€” ${i?.label||""}`})},[u,i]),ce=r.useCallback(n=>{u({selectedGame:n,fromComponent:`Classement Mensuel â€” ${i?.label||""}`})},[u,i]),de=Math.round(w*.8),K=a>0;return!p||p.length===0?e.jsx("div",{className:"donnees-manquantes",children:"Aucune donnÃ©e disponible pour le classement mensuel"}):h.length===0?e.jsx("div",{className:"donnees-manquantes",children:"Aucun mois avec des parties trouvÃ©"}):e.jsxs("div",{className:"lycans-players-stats",children:[e.jsx("h2",{children:"Classement Mensuel"}),e.jsxs("p",{className:"lycans-stats-info",children:["Classement des joueurs par taux de victoire pour chaque mois",e.jsx("br",{}),e.jsx("span",{style:{fontSize:"0.85rem",fontStyle:"italic"},children:"Seuls les joueurs ayant participÃ© Ã  au moins 40% des parties du mois sont classÃ©s"})]}),e.jsx("div",{className:"lycans-graphiques-groupe",children:e.jsxs("div",{className:"lycans-graphique-section",children:[e.jsxs("div",{children:[e.jsx("h3",{children:"Classement Mensuel â€” Taux de Victoire"}),ee&&o.highlightedPlayer&&e.jsxs("p",{style:{fontSize:"0.8rem",color:"var(--accent-primary)",fontStyle:"italic",marginTop:"0.25rem",marginBottom:"0.5rem"},children:['ðŸŽ¯ "',o.highlightedPlayer,'" affichÃ© en plus du classement']})]}),e.jsxs("div",{className:"monthly-nav",children:[e.jsx("button",{onClick:te,disabled:!E,children:"â—€"}),e.jsx("select",{value:D||"",onChange:n=>v(n.target.value),children:h.map(n=>e.jsx("option",{value:n,children:Z(n)},n))}),e.jsx("button",{onClick:ne,disabled:!O,children:"â–¶"})]}),i&&i.totalGames>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"monthly-controls",children:[e.jsx("button",{onClick:se,children:"â—€ PrÃ©cÃ©dente"}),e.jsx("button",{className:`monthly-play-btn ${g?"monthly-play-btn--active":""}`,onClick:ae,disabled:i.totalGames===0,children:g?"â¸ Pause":"â–¶ Play"}),e.jsx("button",{onClick:ie,children:"Suivante â–¶"}),e.jsxs("select",{value:w,onChange:n=>F(Number(n.target.value)),children:[e.jsx("option",{value:2e3,children:"Lent (2s)"}),e.jsx("option",{value:1e3,children:"Normal (1s)"}),e.jsx("option",{value:500,children:"Rapide (0.5s)"}),e.jsx("option",{value:250,children:"TrÃ¨s rapide (0.25s)"})]})]}),e.jsx(Te,{totalGames:i.totalGames,currentGameIndex:a,isPlaying:g,onSeek:re,onPause:le})]}),K&&B&&e.jsx(Ae,{game:B,onGameClick:ce}),e.jsx(je,{title:`Classement Mensuel â€” ${i?.label||""}`,children:n=>e.jsx(Re,{players:$,playersColor:b,highlightedPlayer:o.highlightedPlayer??null,transitionDuration:de,onPlayerClick:oe,isFullscreen:n,isAnimating:K})}),e.jsx("p",{style:{fontSize:"0.8rem",color:"var(--text-secondary)",textAlign:"center",marginTop:"0.5rem"},children:i&&e.jsxs(e.Fragment,{children:[$.filter(n=>!n.isHighlightedAddition).length," joueur",$.filter(n=>!n.isHighlightedAddition).length>1?"s":""," classÃ©",$.filter(n=>!n.isHighlightedAddition).length>1?"s":""," sur"," ",V," partie",V>1?"s":"",a>0?" (animation)":" ce mois"," ","(min. ",q," partie",q>1?"s":""," â€” ",Math.round(X*100),"%)",L!=="0"&&e.jsxs(e.Fragment,{children:[" Â· Moyenne: ",L,"%"]})]})})]})})]})}export{Oe as MonthlyRankingChart};
