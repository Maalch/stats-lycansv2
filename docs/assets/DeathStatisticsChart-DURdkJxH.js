import{u as $,r as M,a as w,j as e}from"./index-0QK-UIqt.js";import{u as V}from"./baseStatsHook-BQbKs5_Y.js";import{g as B}from"./gameUtils-C0qLdSzT.js";import{F as G,B as H,C as E,X as W,Y as F,a as L,b as R}from"./FullscreenChart-C9budMyo.js";import{u as J}from"./api-Y2xxLRyx.js";import{R as q,T as I}from"./CategoricalChart-Dmcjhx4d.js";function O(m){const l=new Set;m.forEach(d=>{d.PlayerStats.forEach(g=>{if(d.PlayerStats.some(x=>x.KillerName===g.Username)){const x=B(g.MainRoleInitial,{regroupLovers:!0,regroupVillagers:!0,regroupTraitor:!0});l.add(x)}})});const o=Array.from(l),c=["Villageois","Loup","Amoureux"];return[...c.filter(d=>o.includes(d)),...o.filter(d=>!c.includes(d)).sort()]}function U(m){if(!m)return null;const l=m.match(/^([NJM])(\d+)$/);if(!l)return null;const[,o,c]=l,p=parseInt(c,10);let d;switch(o){case"N":d="Nuit";break;case"J":d="Jour";break;case"M":d="Meeting";break;default:return null}return{phase:d,day:p,originalString:m}}function X(m){if(!m)return"Survivant";const l=m.trim();return l.includes("vote")||l.includes("Vote")?"Mort aux votes":l.includes("Loup")||l.includes("loup")?"Tué par Loup":l.includes("Zombie")||l.includes("zombie")?"Tué par Zombie":l.includes("Chasseur")||l.includes("chasseur")?"Tué par Chasseur":l.includes("Déco")||l.includes("déco")?"Déconnexion":l.includes("Potion")||l.includes("potion")?"Tué par Potion":l}function Y(m,l){return m.PlayerStats.filter(o=>o.DeathTiming||o.DeathType).map(o=>{let c=null;if(o.KillerName){const p=m.PlayerStats.find(d=>d.Username===o.KillerName);p&&(c=B(p.MainRoleInitial,{regroupLovers:!0,regroupVillagers:!0,regroupTraitor:!0}))}return{playerName:o.Username,deathTiming:U(o.DeathTiming),deathType:X(o.DeathType),killerName:o.KillerName,killerCamp:c}}).filter(o=>!l||l==="Tous les camps"?!0:o.killerCamp===l)}function Z(m,l){if(m.length===0)return null;const o=[],c={},p=new Set;m.forEach(t=>{const a=Y(t,l);a.length>0&&p.add(t.Id),a.forEach(i=>{o.push({...i,gameId:t.Id})}),t.PlayerStats.forEach(i=>{const u=i.Username;(!l||l==="Tous les camps"||B(i.MainRoleInitial,{regroupLovers:!0,regroupVillagers:!0,regroupTraitor:!0})===l)&&(c[u]=(c[u]||0)+1)})});const d=o.length,g=m.length,N=p.size,x=g>0?d/g:0,n={},P={Nuit:0,Jour:0,Meeting:0};o.forEach(t=>{if(t.deathTiming){const a=`${t.deathTiming.phase}-${t.deathTiming.day}`;n[a]=(n[a]||0)+1,P[t.deathTiming.phase]++}});const y=Object.entries(n).map(([t,a])=>{const[i,u]=t.split("-");return{phase:i,day:parseInt(u,10),count:a,percentage:d>0?a/d*100:0}}).sort((t,a)=>{if(t.phase!==a.phase){const i={Nuit:0,Jour:1,Meeting:2};return i[t.phase]-i[a.phase]}return t.day-a.day}),T={};o.forEach(t=>{T[t.deathType]=(T[t.deathType]||0)+1});const D=Object.entries(T).map(([t,a])=>({type:t,count:a,percentage:d>0?a/d*100:0})).sort((t,a)=>a.count-t.count),v={};o.forEach(t=>{t.killerName&&(v[t.killerName]||(v[t.killerName]={kills:0,victims:new Set}),v[t.killerName].kills++,v[t.killerName].victims.add(t.playerName))});const f=Object.entries(v).map(([t,a])=>{const i=c[t]||0,u=i>0?a.kills/i:0;return{killerName:t,kills:a.kills,victims:Array.from(a.victims),percentage:d>0?a.kills/d*100:0,gamesPlayed:i,averageKillsPerGame:u}}).sort((t,a)=>a.kills-t.kills),S={};o.forEach(t=>{S[t.playerName]||(S[t.playerName]={totalDeaths:0,deathsByPhase:{Nuit:0,Jour:0,Meeting:0},deathsByType:{},killedBy:{},deathDays:[]});const a=S[t.playerName];a.totalDeaths++,t.deathTiming&&(a.deathsByPhase[t.deathTiming.phase]++,a.deathDays.push(t.deathTiming.day)),a.deathsByType[t.deathType]=(a.deathsByType[t.deathType]||0)+1,t.killerName&&(a.killedBy[t.killerName]=(a.killedBy[t.killerName]||0)+1)});const A=Object.entries(S).map(([t,a])=>({playerName:t,totalDeaths:a.totalDeaths,deathsByPhase:a.deathsByPhase,deathsByType:a.deathsByType,killedBy:a.killedBy,averageDeathDay:a.deathDays.length>0?a.deathDays.reduce((i,u)=>i+u,0)/a.deathDays.length:null,deathRate:c[t]>0?a.totalDeaths/c[t]:0})).sort((t,a)=>a.totalDeaths-t.totalDeaths),b=Object.entries(P).reduce((t,[a,i])=>i>t.count?{phase:a,count:i}:t,{phase:"Nuit",count:0}).phase,k={};o.forEach(t=>{t.deathTiming&&(k[t.deathTiming.day]=(k[t.deathTiming.day]||0)+1)});const C=Object.entries(k).reduce((t,[a,i])=>i>t.count?{day:parseInt(a,10),count:i}:t,{day:1,count:0}).day,r=D.length>0?D[0].type:"",h=f.length>0?f[0].killerName:null;return{totalDeaths:d,totalGames:g,gamesWithDeaths:N,averageDeathsPerGame:x,deathsByTiming:y,deathsByPhase:P,deathsByType:D,killerStats:f,playerDeathStats:A,mostDeadlyPhase:b,mostDeadlyDay:C,mostCommonDeathType:r,mostDeadlyKiller:h}}function Q(m){return V(l=>Z(l,m))}function _(){return V(m=>O(m))}function le(){const{navigateToGameDetails:m,navigationState:l,updateNavigationState:o}=$(),[c,p]=M.useState(l.deathStatsSelectedCamp||"Tous les camps"),{data:d}=_(),{data:g,isLoading:N,error:x}=Q(c),{settings:n}=w(),[P,y]=M.useState(null),T=J(),D=r=>{p(r),o({deathStatsSelectedCamp:r})},{totalKillsData:v,averageKillsData:f,highlightedPlayerAddedToTotal:S,highlightedPlayerAddedToAverage:A,gamesWithKillers:b}=M.useMemo(()=>{if(!g)return{totalKillsData:[],averageKillsData:[],highlightedPlayerAddedToTotal:!1,highlightedPlayerAddedToAverage:!1,gamesWithKillers:0};const r=g.killerStats.sort((s,j)=>j.kills-s.kills).slice(0,20),h=n.highlightedPlayer&&r.some(s=>s.killerName===n.highlightedPlayer),t=r.map(s=>({name:s.killerName,value:s.kills,victims:s.victims.length,percentage:s.percentage,gamesPlayed:s.gamesPlayed,averageKillsPerGame:s.averageKillsPerGame,isHighlightedAddition:!1}));let a=!1;if(n.highlightedPlayer&&!h){const s=g.killerStats.find(j=>j.killerName===n.highlightedPlayer);s&&(t.push({name:s.killerName,value:s.kills,victims:s.victims.length,percentage:s.percentage,gamesPlayed:s.gamesPlayed,averageKillsPerGame:s.averageKillsPerGame,isHighlightedAddition:!0}),a=!0)}const i=g.killerStats.sort((s,j)=>j.averageKillsPerGame-s.averageKillsPerGame).slice(0,20),u=n.highlightedPlayer&&i.some(s=>s.killerName===n.highlightedPlayer),K=i.map(s=>({name:s.killerName,value:s.averageKillsPerGame,victims:s.victims.length,percentage:s.percentage,gamesPlayed:s.gamesPlayed,averageKillsPerGame:s.averageKillsPerGame,isHighlightedAddition:!1}));let z=!1;if(n.highlightedPlayer&&!u){const s=g.killerStats.find(j=>j.killerName===n.highlightedPlayer);s&&(K.push({name:s.killerName,value:s.averageKillsPerGame,victims:s.victims.length,percentage:s.percentage,gamesPlayed:s.gamesPlayed,averageKillsPerGame:s.averageKillsPerGame,isHighlightedAddition:!0}),z=!0)}return{totalKillsData:t,averageKillsData:K,highlightedPlayerAddedToTotal:a,highlightedPlayerAddedToAverage:z,gamesWithKillers:g.gamesWithDeaths}},[g,n.highlightedPlayer]);if(N)return e.jsx("div",{className:"donnees-attente",children:"Chargement des statistiques de mort..."});if(x)return e.jsxs("div",{className:"donnees-probleme",children:["Erreur: ",x]});if(!g)return e.jsx("div",{className:"donnees-manquantes",children:"Aucune donnée de mort disponible"});const k=({active:r,payload:h,label:t})=>{if(r&&h&&h.length){const a=h[0].payload,i=a.isHighlightedAddition,u=n.highlightedPlayer===a.name;return e.jsxs("div",{style:{background:"var(--bg-secondary)",border:"1px solid var(--border-color)",borderRadius:"8px",padding:"12px",boxShadow:"0 4px 12px rgba(0,0,0,0.15)",color:"var(--text-primary)",fontSize:"0.9rem"},children:[e.jsxs("p",{style:{fontWeight:"bold",marginBottom:"8px",color:u?"var(--accent-primary)":"var(--text-primary)"},children:[t,i&&e.jsx("span",{style:{color:"var(--accent-primary)",fontSize:"0.8rem",fontStyle:"italic",marginLeft:"4px"},children:" (🎯)"})]}),e.jsxs("p",{style:{color:"var(--accent-secondary)",margin:"4px 0"},children:[e.jsx("strong",{children:"Victimes totales:"})," ",a.value]}),e.jsxs("p",{style:{color:"var(--accent-tertiary)",margin:"4px 0"},children:[e.jsx("strong",{children:"Parties jouées:"})," ",a.gamesPlayed]}),e.jsxs("p",{style:{color:"var(--chart-color-5)",margin:"4px 0"},children:[e.jsx("strong",{children:"Victimes uniques:"})," ",a.victims]}),e.jsxs("p",{style:{color:"var(--chart-color-2)",margin:"4px 0"},children:[e.jsx("strong",{children:"Moyenne par partie:"})," ",a.averageKillsPerGame.toFixed(2)]}),i&&e.jsx("div",{style:{fontSize:"0.75rem",color:"var(--accent-primary)",marginTop:"0.25rem",fontStyle:"italic"},children:"🎯 Affiché via sélection personnelle"}),u&&!i&&e.jsx("div",{style:{fontSize:"0.75rem",color:"var(--accent-primary)",marginTop:"0.25rem",fontStyle:"italic"},children:"🎯 Joueur sélectionné"}),e.jsx("div",{style:{fontSize:"0.8rem",color:"var(--accent-primary)",marginTop:"0.5rem",fontWeight:"bold",textAlign:"center",animation:"pulse 1.5s infinite"},children:"🖱️ Cliquez pour voir les parties"})]})}return null},C=({active:r,payload:h,label:t})=>{if(r&&h&&h.length){const a=h[0].payload,i=a.isHighlightedAddition,u=n.highlightedPlayer===a.name;return e.jsxs("div",{style:{background:"var(--bg-secondary)",border:"1px solid var(--border-color)",borderRadius:"8px",padding:"12px",boxShadow:"0 4px 12px rgba(0,0,0,0.15)",color:"var(--text-primary)",fontSize:"0.9rem"},children:[e.jsxs("p",{style:{fontWeight:"bold",marginBottom:"8px",color:u?"var(--accent-primary)":"var(--text-primary)"},children:[t,i&&e.jsx("span",{style:{color:"var(--accent-primary)",fontSize:"0.8rem",fontStyle:"italic",marginLeft:"4px"},children:" (🎯)"})]}),e.jsxs("p",{style:{color:"var(--accent-secondary)",margin:"4px 0"},children:[e.jsx("strong",{children:"Moyenne par partie:"})," ",a.value.toFixed(2)]}),e.jsxs("p",{style:{color:"var(--accent-tertiary)",margin:"4px 0"},children:[e.jsx("strong",{children:"Parties jouées:"})," ",a.gamesPlayed]}),e.jsxs("p",{style:{color:"var(--chart-color-5)",margin:"4px 0"},children:[e.jsx("strong",{children:"Victimes uniques:"})," ",a.victims]}),e.jsxs("p",{style:{color:"var(--chart-color-2)",margin:"4px 0"},children:[e.jsx("strong",{children:"Victimes totales:"})," ",Math.round(a.averageKillsPerGame*a.gamesPlayed)]}),i&&e.jsx("div",{style:{fontSize:"0.75rem",color:"var(--accent-primary)",marginTop:"0.25rem",fontStyle:"italic"},children:"🎯 Affiché via sélection personnelle"}),u&&!i&&e.jsx("div",{style:{fontSize:"0.75rem",color:"var(--accent-primary)",marginTop:"0.25rem",fontStyle:"italic"},children:"🎯 Joueur sélectionné"}),e.jsx("div",{style:{fontSize:"0.8rem",color:"var(--accent-primary)",marginTop:"0.5rem",fontWeight:"bold",textAlign:"center",animation:"pulse 1.5s infinite"},children:"🖱️ Cliquez pour voir les parties"})]})}return null};return e.jsxs("div",{className:"lycans-players-stats",children:[e.jsx("h2",{children:"Statistiques de Mort"}),e.jsxs("p",{className:"lycans-stats-info",children:["Analyse de ",g.totalDeaths," morts avec ",g.killerStats.length," tueurs identifiés",c!=="Tous les camps"&&` - Camp: ${c}`]}),e.jsxs("div",{style:{marginBottom:"1.5rem",display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("label",{htmlFor:"camp-select",style:{color:"var(--text-secondary)",fontSize:"0.9rem",fontWeight:"bold"},children:"Camp :"}),e.jsxs("select",{id:"camp-select",value:c,onChange:r=>D(r.target.value),style:{background:"var(--bg-tertiary)",color:"var(--text-primary)",border:"1px solid var(--border-color)",borderRadius:"4px",padding:"0.5rem",fontSize:"0.9rem",minWidth:"150px"},children:[e.jsx("option",{value:"Tous les camps",children:"Tous les camps"}),d?.map(r=>e.jsx("option",{value:r,children:r},r))]})]}),e.jsxs("div",{className:"lycans-resume-conteneur",style:{marginBottom:"2rem"},children:[e.jsxs("div",{className:"lycans-stat-carte",children:[e.jsx("h3",{children:"Total des morts"}),e.jsx("div",{className:"lycans-valeur-principale",style:{color:"var(--accent-secondary)"},children:g.totalDeaths})]}),e.jsxs("div",{className:"lycans-stat-carte",children:[e.jsx("h3",{children:"Tueurs identifiés"}),e.jsx("div",{className:"lycans-valeur-principale",style:{color:"var(--chart-color-1)"},children:g.killerStats.length})]}),e.jsxs("div",{className:"lycans-stat-carte",children:[e.jsx("h3",{children:"Nombre de parties enregistrées"}),e.jsx("div",{className:"lycans-valeur-principale",style:{color:"var(--accent-primary)"},children:b})]})]}),e.jsxs("div",{className:"lycans-graphiques-groupe",children:[e.jsxs("div",{className:"lycans-graphique-section",children:[e.jsxs("div",{children:[e.jsx("h3",{children:"Top Tueurs (Total)"}),S&&n.highlightedPlayer&&e.jsxs("p",{style:{fontSize:"0.8rem",color:"var(--accent-primary)",fontStyle:"italic",marginTop:"0.25rem",marginBottom:"0.5rem"},children:['🎯 "',n.highlightedPlayer,'" affiché en plus du top 20']})]}),e.jsx(G,{title:"Top Tueurs (Total)",children:e.jsx("div",{style:{height:400},children:e.jsx(q,{width:"100%",height:"100%",children:e.jsxs(H,{data:v,margin:{top:20,right:30,left:20,bottom:10},onMouseEnter:()=>{},onMouseLeave:()=>y(null),children:[e.jsx(E,{strokeDasharray:"3 3"}),e.jsx(W,{dataKey:"name",angle:-45,textAnchor:"end",height:80,interval:0,tick:({x:r,y:h,payload:t})=>e.jsx("text",{x:r,y:h,dy:16,textAnchor:"end",fill:n.highlightedPlayer===t.value?"var(--accent-primary)":"var(--text-secondary)",fontSize:n.highlightedPlayer===t.value?14:13,fontWeight:n.highlightedPlayer===t.value?"bold":"italic",transform:`rotate(-45 ${r} ${h})`,children:t.value})}),e.jsx(F,{label:{value:"Nombre total de victimes",angle:270,position:"left",style:{textAnchor:"middle"}}}),e.jsx(I,{content:e.jsx(k,{})}),e.jsx(L,{dataKey:"value",name:"Victimes",onMouseEnter:r=>y(r?.name||null),children:v.map(r=>{const h=n.highlightedPlayer===r.name,t=P===r.name,a=r.isHighlightedAddition;return e.jsx(R,{fill:T[r.name]||"#e53e3e",stroke:h?"var(--accent-primary)":t?"var(--text-primary)":"none",strokeWidth:h?3:t?2:0,strokeDasharray:a?"5,5":"none",opacity:a?.8:1,onClick:()=>{const i={selectedPlayer:r.name,fromComponent:"Statistiques de Mort"};c!=="Tous les camps"&&(i.campFilter={selectedCamp:c,campFilterMode:"all-assignments"}),m(i)},onMouseEnter:()=>y(r.name),onMouseLeave:()=>y(null),style:{cursor:"pointer"}},`cell-total-${r.name}`)})})]})})})}),e.jsxs("p",{style:{fontSize:"0.8rem",color:"var(--text-secondary)",textAlign:"center",marginTop:"0.5rem"},children:["Top ",Math.min(20,v.filter(r=>!r.isHighlightedAddition).length)," des tueurs les plus actifs (total)"]})]}),e.jsxs("div",{className:"lycans-graphique-section",children:[e.jsxs("div",{children:[e.jsx("h3",{children:"Top Tueurs (Moyenne par Partie)"}),A&&n.highlightedPlayer&&e.jsxs("p",{style:{fontSize:"0.8rem",color:"var(--accent-primary)",fontStyle:"italic",marginTop:"0.25rem",marginBottom:"0.5rem"},children:['🎯 "',n.highlightedPlayer,'" affiché en plus du top 20']})]}),e.jsx(G,{title:"Top Tueurs (Moyenne par Partie)",children:e.jsx("div",{style:{height:400},children:e.jsx(q,{width:"100%",height:"100%",children:e.jsxs(H,{data:f,margin:{top:20,right:30,left:20,bottom:10},onMouseEnter:()=>{},onMouseLeave:()=>y(null),children:[e.jsx(E,{strokeDasharray:"3 3"}),e.jsx(W,{dataKey:"name",angle:-45,textAnchor:"end",height:80,interval:0,tick:({x:r,y:h,payload:t})=>e.jsx("text",{x:r,y:h,dy:16,textAnchor:"end",fill:n.highlightedPlayer===t.value?"var(--accent-primary)":"var(--text-secondary)",fontSize:n.highlightedPlayer===t.value?14:13,fontWeight:n.highlightedPlayer===t.value?"bold":"italic",transform:`rotate(-45 ${r} ${h})`,children:t.value})}),e.jsx(F,{label:{value:"Moyenne de victimes par partie",angle:270,position:"left",style:{textAnchor:"middle"}}}),e.jsx(I,{content:e.jsx(C,{})}),e.jsx(L,{dataKey:"value",name:"Moyenne",onMouseEnter:r=>y(r?.name||null),children:f.map(r=>{const h=n.highlightedPlayer===r.name,t=P===r.name,a=r.isHighlightedAddition;return e.jsx(R,{fill:T[r.name]||"#8884d8",stroke:h?"var(--accent-primary)":t?"var(--text-primary)":"none",strokeWidth:h?3:t?2:0,strokeDasharray:a?"5,5":"none",opacity:a?.8:1,onClick:()=>{const i={selectedPlayer:r.name,fromComponent:"Statistiques de Mort"};c!=="Tous les camps"&&(i.campFilter={selectedCamp:c,campFilterMode:"all-assignments"}),m(i)},onMouseEnter:()=>y(r.name),onMouseLeave:()=>y(null),style:{cursor:"pointer"}},`cell-average-${r.name}`)})})]})})})}),e.jsxs("p",{style:{fontSize:"0.8rem",color:"var(--text-secondary)",textAlign:"center",marginTop:"0.5rem"},children:["Top ",Math.min(20,f.filter(r=>!r.isHighlightedAddition).length)," des tueurs les plus efficaces (moyenne)"]})]})]}),e.jsx("div",{className:"lycans-section-description",style:{marginTop:"1.5rem"},children:e.jsxs("p",{children:[e.jsx("strong",{children:"Note : "}),"Les morts lors de votes aux conseils ne sont pas comptabilisées ici. ","Données en cours de récupération (données partielles)."]})})]})}export{le as DeathStatisticsChart};
